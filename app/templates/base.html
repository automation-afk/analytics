<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}YouTube Analytics Dashboard{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23dc3545'/><path d='M30 70 L30 40 L45 55 L60 35 L75 50 L75 70 Z' fill='white' opacity='0.9'/><circle cx='30' cy='40' r='5' fill='white'/><circle cx='45' cy='55' r='5' fill='white'/><circle cx='60' cy='35' r='5' fill='white'/><circle cx='75' cy='50' r='5' fill='white'/></svg>">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('dashboard.overview') }}">
                <i class="fas fa-chart-line"></i> YT Analytics
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard.overview') }}">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard.videos_list') }}">
                            <i class="fas fa-video"></i> Videos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard.conversion_audit') }}">
                            <i class="fas fa-chart-line"></i> Conversion Audit
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-clipboard-check"></i> Script Scores
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('dashboard.script_scores_library') }}"><i class="fas fa-table me-1"></i> Library</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('dashboard.script_scores_trends') }}"><i class="fas fa-chart-area me-1"></i> Trends</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('analysis.history') }}">
                            <i class="fas fa-history"></i> History
                        </a>
                    </li>
                </ul>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Task Progress Notification -->
                    <div id="navTaskNotif" class="dropdown position-relative" style="display: none;">
                        <button class="btn btn-outline-light btn-sm position-relative" id="navTaskBtn" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                            <i class="fas fa-cog fa-spin" id="navTaskIconSpin"></i>
                            <i class="fas fa-check-circle text-success" id="navTaskIconDone" style="display: none;"></i>
                            <i class="fas fa-exclamation-circle text-danger" id="navTaskIconError" style="display: none;"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="navTaskBadge" style="font-size: 0.55rem;">1</span>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end p-0" id="navTaskDropdown" style="min-width: 320px;">
                            <div class="px-3 py-2 bg-dark text-white d-flex justify-content-between align-items-center" style="border-radius: 0.375rem 0.375rem 0 0;">
                                <small class="fw-bold"><i class="fas fa-tasks me-1"></i> Running Tasks</small>
                                <span class="badge bg-danger" id="navTaskDropdownCount">0</span>
                            </div>
                            <div id="navTaskList" class="p-2">
                                <div class="text-muted text-center py-2"><small>No tasks running</small></div>
                            </div>
                        </div>
                    </div>
                    <button id="darkModeToggle" class="btn btn-outline-light btn-sm" title="Toggle Dark Mode">
                        <i id="darkModeIcon" class="fas fa-moon"></i>
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#logoutModal" title="Logout">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main class="container-fluid mt-4">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer mt-auto py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">YouTube Analytics Dashboard &copy; 2026</span>
        </div>
    </footer>

    <!-- Logout Confirmation Modal -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title" id="logoutModalLabel">
                        <i class="fas fa-sign-out-alt me-2"></i>Confirm Logout
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="fas fa-user-circle text-secondary mb-3" style="font-size: 3rem;"></i>
                    <p class="mb-0">Are you sure you want to logout?</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt me-1"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <!-- Global Background Task Badge Checker -->
    <script>
    (function() {
        const navNotif = document.getElementById('navTaskNotif');
        const navBtn = document.getElementById('navTaskBtn');
        const navBadge = document.getElementById('navTaskBadge');
        const navSpin = document.getElementById('navTaskIconSpin');
        const navDone = document.getElementById('navTaskIconDone');
        const navError = document.getElementById('navTaskIconError');
        const navTaskList = document.getElementById('navTaskList');
        const navTaskDropdownCount = document.getElementById('navTaskDropdownCount');
        if (!navNotif) return;

        let checkInterval = null;

        function buildTaskItem(type, title, videoId, pct, step) {
            const icon = type === 'transcribe' ? 'fa-microphone' : 'fa-brain';
            const color = type === 'transcribe' ? 'success' : 'primary';
            const label = type === 'transcribe' ? 'Transcribing' : 'Analyzing';
            const shortTitle = title ? (title.length > 40 ? title.substring(0, 40) + '...' : title) : videoId;
            const stepText = step ? '<div class="text-muted" style="font-size:0.7rem;">' + step + '</div>' : '';

            return '<a href="/videos/' + videoId + '" class="d-block text-decoration-none text-dark p-2 rounded task-item" style="background:#f8f9fa; margin-bottom:4px;">'
                + '<div class="d-flex align-items-center gap-2">'
                + '<i class="fas ' + icon + ' text-' + color + '"></i>'
                + '<div class="flex-grow-1" style="min-width:0;">'
                + '<div class="fw-semibold" style="font-size:0.8rem;">' + label + '</div>'
                + '<div class="text-truncate" style="font-size:0.75rem;">' + shortTitle + '</div>'
                + stepText
                + '</div>'
                + '<div class="text-end" style="min-width:45px;">'
                + '<div class="fw-bold text-' + color + '" style="font-size:0.85rem;">' + pct + '%</div>'
                + '</div>'
                + '</div>'
                + '<div class="progress mt-1" style="height:3px;">'
                + '<div class="progress-bar bg-' + color + '" style="width:' + pct + '%"></div>'
                + '</div>'
                + '</a>';
        }

        function checkTasks() {
            Promise.all([
                fetch('/api/v1/analysis/status').then(r => r.json()).catch(() => ({ is_analyzing: false, videos_analyzing: [] })),
                fetch('/api/v1/transcribe/status').then(r => r.json()).catch(() => ({ is_transcribing: false, videos_transcribing: [] }))
            ]).then(([aData, tData]) => {
                let count = 0;
                let html = '';

                if (tData.is_transcribing && tData.videos_transcribing && tData.videos_transcribing.length > 0) {
                    count++;
                    const t = tData.videos_transcribing[0];
                    html += buildTaskItem('transcribe', t.title, t.video_id, t.progress || 0, t.step || '');
                }
                if (aData.is_analyzing && aData.videos_analyzing && aData.videos_analyzing.length > 0) {
                    count++;
                    const a = aData.videos_analyzing[0];
                    html += buildTaskItem('analysis', a.title, a.video_id, a.progress || 0, a.step || '');
                }

                if (count > 0) {
                    navNotif.style.display = 'block';
                    navBadge.textContent = count;
                    navTaskDropdownCount.textContent = count;
                    navSpin.style.display = 'inline-block';
                    navDone.style.display = 'none';
                    navError.style.display = 'none';
                    navTaskList.innerHTML = html;
                } else {
                    navNotif.style.display = 'none';
                    navTaskList.innerHTML = '<div class="text-muted text-center py-2"><small>No tasks running</small></div>';
                }
            }).catch(() => {});
        }

        // Start polling on all pages
        checkTasks();
        checkInterval = setInterval(checkTasks, 5000);
        window.addEventListener('beforeunload', function() {
            if (checkInterval) clearInterval(checkInterval);
        });
    })();
    </script>

    <!-- Dark Mode Toggle -->
    <script>
        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModeIcon = document.getElementById('darkModeIcon');
        const htmlElement = document.documentElement;

        // Check for saved theme preference or default to light mode
        const currentTheme = localStorage.getItem('theme') || 'light';
        htmlElement.setAttribute('data-theme', currentTheme);
        updateDarkModeIcon(currentTheme);

        darkModeToggle.addEventListener('click', function() {
            const theme = htmlElement.getAttribute('data-theme');
            const newTheme = theme === 'light' ? 'dark' : 'light';

            htmlElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateDarkModeIcon(newTheme);

            // Log theme change
            logActivity('Toggle Theme', 'theme=' + newTheme);
        });

        function updateDarkModeIcon(theme) {
            if (theme === 'dark') {
                darkModeIcon.classList.remove('fa-moon');
                darkModeIcon.classList.add('fa-sun');
            } else {
                darkModeIcon.classList.remove('fa-sun');
                darkModeIcon.classList.add('fa-moon');
            }
        }
    </script>

    <!-- Activity Tracking -->
    <script>
        // Function to log activity to server
        function logActivity(action, details) {
            fetch('/api/v1/log-activity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: action, details: details || '' })
            }).catch(err => console.debug('Activity log failed:', err));
        }

        // Track navigation clicks
        document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
            link.addEventListener('click', function() {
                const pageName = this.textContent.trim();
                logActivity('Navigate', 'page=' + pageName);
            });
        });

        // Track YouTube external links
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a[href*="youtube.com"], a[href*="youtu.be"]');
            if (link) {
                const videoId = link.href.match(/(?:v=|youtu\.be\/)([^&\?]+)/);
                logActivity('Watch on YouTube', 'url=' + link.href + (videoId ? ', video_id=' + videoId[1] : ''));
            }
        });

        // Track tab switches (Bootstrap tabs)
        document.addEventListener('shown.bs.tab', function(e) {
            const tabName = e.target.textContent.trim() || e.target.getAttribute('data-bs-target');
            logActivity('Switch Tab', 'tab=' + tabName);
        });

        // Track modal opens
        document.addEventListener('shown.bs.modal', function(e) {
            const modalId = e.target.id;
            const modalTitle = e.target.querySelector('.modal-title')?.textContent?.trim() || modalId;
            logActivity('Open Modal', 'modal=' + modalTitle);
        });

        // Track modal closes (including progress bar close)
        document.addEventListener('hidden.bs.modal', function(e) {
            const modalId = e.target.id;
            const modalTitle = e.target.querySelector('.modal-title')?.textContent?.trim() || modalId;
            logActivity('Close Modal', 'modal=' + modalTitle);
        });

        // Track button clicks with specific data attributes or classes
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('button, .btn');
            if (!btn) return;

            // Skip if it's a nav link or already tracked
            if (btn.closest('.navbar-nav')) return;

            // Get button context
            let action = '';
            let details = '';

            // Check for specific buttons
            if (btn.id === 'statusCloseBtn' || btn.id === 'analysisCloseBtn') {
                action = 'Close Progress Bar';
                details = btn.id === 'statusCloseBtn' ? 'transcription' : 'analysis';
            } else if (btn.id === 'reanalyzeBtn' || btn.classList.contains('reanalyze-btn')) {
                action = 'Click Re-Analyze';
            } else if (btn.id === 'confirmReanalyzeBtn') {
                action = 'Confirm Re-Analyze';
            } else if (btn.id === 'startBtn' || btn.classList.contains('start-transcribe')) {
                action = 'Click Start Transcribe';
            } else if (btn.dataset.bsTarget === '#transcribeModal') {
                action = 'Open Transcribe Modal';
            } else if (btn.dataset.bsTarget === '#reanalyzeModal') {
                action = 'Open Re-Analyze Modal';
            } else if (btn.classList.contains('btn-primary') || btn.classList.contains('btn-success')) {
                // Generic action button
                const btnText = btn.textContent.trim().substring(0, 30);
                if (btnText) {
                    action = 'Click Button';
                    details = 'text=' + btnText;
                }
            }

            if (action) {
                logActivity(action, details);
            }
        });

        // Track filter form submissions
        document.addEventListener('submit', function(e) {
            const form = e.target;
            if (form.closest('.card') && form.querySelector('[name="channel"], [name="video_id"], [name="has_analysis"]')) {
                logActivity('Apply Filters', 'form submitted');
            }
        });

        // Track dropdown changes (channel filter, etc.)
        document.addEventListener('change', function(e) {
            const select = e.target;
            if (select.tagName === 'SELECT') {
                const name = select.name || select.id;
                const value = select.value;
                if (name && (name.includes('channel') || name.includes('analysis'))) {
                    logActivity('Change Filter', name + '=' + value);
                }
            }
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
