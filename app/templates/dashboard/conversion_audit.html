{% extends "base.html" %}

{% block title %}Conversion Audit - YouTube Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h1 class="mb-0">
                <i class="fas fa-chart-line"></i> Conversion Audit
            </h1>
            <a href="{{ url_for('dashboard.conversion_audit_export', channel=channel_code, keyword=keyword_search, silo=silo_filter, sort_by=sort_by, sort_dir=sort_dir) }}"
               class="btn btn-success">
                <i class="fas fa-file-csv me-1"></i> Export CSV
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <form method="get" action="{{ url_for('dashboard.conversion_audit') }}" class="row g-2 align-items-end">
                        <div class="col-12 col-sm-6 col-lg-3">
                            <label for="channel" class="form-label mb-1 small">Channel</label>
                            <select class="form-select form-select-sm" id="channel" name="channel">
                                <option value="">All Channels</option>
                                {% for ch in all_channels %}
                                <option value="{{ ch }}" {% if channel_code == ch %}selected{% endif %}>{{ ch }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-sm-6 col-lg-3">
                            <label for="keyword" class="form-label mb-1 small">Keyword / Title</label>
                            <input type="text" class="form-control form-control-sm" id="keyword" name="keyword"
                                   value="{{ keyword_search or '' }}" placeholder="Search keywords or title...">
                        </div>
                        <div class="col-12 col-sm-6 col-lg-3">
                            <label for="silo" class="form-label mb-1 small">Silo</label>
                            <select class="form-select form-select-sm" id="silo" name="silo">
                                <option value="">All Silos</option>
                                {% for s in all_silos %}
                                <option value="{{ s }}" {% if silo_filter == s %}selected{% endif %}>{{ s }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-sm-6 col-lg-3 d-flex gap-2">
                            <button type="submit" class="btn btn-primary btn-sm flex-grow-1">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <a href="{{ url_for('dashboard.conversion_audit') }}" class="btn btn-secondary btn-sm flex-grow-1">
                                <i class="fas fa-times"></i> Clear
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    {% if audit_data %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0" id="auditTable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="sticky-col" style="min-width:250px;">
                                        <a href="{{ url_for('dashboard.conversion_audit', page=page, channel=channel_code, keyword=keyword_search, silo=silo_filter, sort_by='title', sort_dir='asc' if sort_by == 'title' and sort_dir == 'asc' else 'desc' if sort_by == 'title' else 'asc') }}" class="text-white text-decoration-none">
                                            Title {% if sort_by == 'title' %}<i class="fas fa-sort-{{ 'up' if sort_dir == 'asc' else 'down' }}"></i>{% endif %}
                                        </a>
                                    </th>
                                    <th style="min-width:100px;">
                                        <a href="{{ url_for('dashboard.conversion_audit', page=page, channel=channel_code, keyword=keyword_search, silo=silo_filter, sort_by='keyword', sort_dir='asc' if sort_by == 'keyword' and sort_dir == 'asc' else 'desc' if sort_by == 'keyword' else 'asc') }}" class="text-white text-decoration-none">
                                            Keyword {% if sort_by == 'keyword' %}<i class="fas fa-sort-{{ 'up' if sort_dir == 'asc' else 'down' }}"></i>{% endif %}
                                        </a>
                                    </th>
                                    <th style="min-width:80px;">
                                        <a href="{{ url_for('dashboard.conversion_audit', page=page, channel=channel_code, keyword=keyword_search, silo=silo_filter, sort_by='silo', sort_dir='asc' if sort_by == 'silo' and sort_dir == 'asc' else 'desc' if sort_by == 'silo' else 'asc') }}" class="text-white text-decoration-none">
                                            Silo {% if sort_by == 'silo' %}<i class="fas fa-sort-{{ 'up' if sort_dir == 'asc' else 'down' }}"></i>{% endif %}
                                        </a>
                                    </th>
                                    <th class="text-end" style="min-width:110px;">
                                        <a href="{{ url_for('dashboard.conversion_audit', page=page, channel=channel_code, keyword=keyword_search, silo=silo_filter, sort_by='avg_monthly_revenue', sort_dir='asc' if sort_by == 'avg_monthly_revenue' and sort_dir == 'desc' else 'desc') }}" class="text-white text-decoration-none">
                                            Avg Rev/mo {% if sort_by == 'avg_monthly_revenue' %}<i class="fas fa-sort-{{ 'up' if sort_dir == 'asc' else 'down' }}"></i>{% endif %}
                                        </a>
                                    </th>
                                    <th class="text-end" style="min-width:110px;">
                                        <a href="{{ url_for('dashboard.conversion_audit', page=page, channel=channel_code, keyword=keyword_search, silo=silo_filter, sort_by='avg_monthly_views', sort_dir='asc' if sort_by == 'avg_monthly_views' and sort_dir == 'desc' else 'desc') }}" class="text-white text-decoration-none">
                                            Avg Views/mo {% if sort_by == 'avg_monthly_views' %}<i class="fas fa-sort-{{ 'up' if sort_dir == 'asc' else 'down' }}"></i>{% endif %}
                                        </a>
                                    </th>
                                    <th class="text-end" style="min-width:70px;">
                                        <a href="{{ url_for('dashboard.conversion_audit', page=page, channel=channel_code, keyword=keyword_search, silo=silo_filter, sort_by='conversion_rate', sort_dir='asc' if sort_by == 'conversion_rate' and sort_dir == 'desc' else 'desc') }}" class="text-white text-decoration-none">
                                            CR % {% if sort_by == 'conversion_rate' %}<i class="fas fa-sort-{{ 'up' if sort_dir == 'asc' else 'down' }}"></i>{% endif %}
                                        </a>
                                    </th>
                                    <th class="text-end" style="min-width:80px;">
                                        <a href="{{ url_for('dashboard.conversion_audit', page=page, channel=channel_code, keyword=keyword_search, silo=silo_filter, sort_by='desc_ctr', sort_dir='asc' if sort_by == 'desc_ctr' and sort_dir == 'desc' else 'desc') }}" class="text-white text-decoration-none">
                                            Desc CTR {% if sort_by == 'desc_ctr' %}<i class="fas fa-sort-{{ 'up' if sort_dir == 'asc' else 'down' }}"></i>{% endif %}
                                        </a>
                                    </th>
                                    <th class="text-end" style="min-width:80px;">
                                        <a href="{{ url_for('dashboard.conversion_audit', page=page, channel=channel_code, keyword=keyword_search, silo=silo_filter, sort_by='pinned_ctr', sort_dir='asc' if sort_by == 'pinned_ctr' and sort_dir == 'desc' else 'desc') }}" class="text-white text-decoration-none">
                                            Pinned CTR {% if sort_by == 'pinned_ctr' %}<i class="fas fa-sort-{{ 'up' if sort_dir == 'asc' else 'down' }}"></i>{% endif %}
                                        </a>
                                    </th>
                                    <th class="text-end" style="min-width:90px;">
                                        <a href="{{ url_for('dashboard.conversion_audit', page=page, channel=channel_code, keyword=keyword_search, silo=silo_filter, sort_by='thumbnail_ctr', sort_dir='asc' if sort_by == 'thumbnail_ctr' and sort_dir == 'desc' else 'desc') }}" class="text-white text-decoration-none">
                                            Thumb CTR {% if sort_by == 'thumbnail_ctr' %}<i class="fas fa-sort-{{ 'up' if sort_dir == 'asc' else 'down' }}"></i>{% endif %}
                                        </a>
                                    </th>
                                    <th style="min-width:60px;">Rank</th>
                                    <th style="min-width:200px;">Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in audit_data %}
                                <tr>
                                    <td class="sticky-col">
                                        <a href="{{ url_for('videos.detail', video_id=row.video_id) }}" class="text-decoration-none fw-semibold" style="font-size:0.85rem;">
                                            {{ row.title[:60] }}{% if row.title|length > 60 %}...{% endif %}
                                        </a>
                                        <br>
                                        <small class="text-muted">{{ row.channel }}</small>
                                    </td>
                                    <td><small>{{ row.keyword or '-' }}</small></td>
                                    <td><small>{{ row.silo or '-' }}</small></td>
                                    <td class="text-end">
                                        {% if row.avg_monthly_revenue > 0 %}
                                        <span class="{% if row.avg_monthly_revenue >= 1000 %}text-success fw-bold{% elif row.avg_monthly_revenue >= 100 %}text-body{% else %}text-muted{% endif %}">
                                            ${{ "%.2f"|format(row.avg_monthly_revenue) }}
                                        </span>
                                        {% else %}<span class="text-muted">-</span>{% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if row.avg_monthly_views > 0 %}
                                        {{ "{:,}".format(row.avg_monthly_views) }}
                                        {% else %}<span class="text-muted">-</span>{% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if row.conversion_rate > 0 %}
                                        <span class="badge {% if row.conversion_rate >= 1 %}bg-success{% elif row.conversion_rate >= 0.1 %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                                            {{ "%.3f"|format(row.conversion_rate) }}%
                                        </span>
                                        {% else %}<span class="text-muted">-</span>{% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if row.desc_ctr > 0 %}
                                        <span class="{% if row.desc_ctr >= 5 %}text-success fw-bold{% elif row.desc_ctr >= 1 %}text-body{% else %}text-muted{% endif %}">
                                            {{ "%.2f"|format(row.desc_ctr) }}%
                                        </span>
                                        {% else %}<span class="text-muted">-</span>{% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if row.pinned_ctr > 0 %}
                                        <span class="{% if row.pinned_ctr >= 5 %}text-success fw-bold{% elif row.pinned_ctr >= 1 %}text-body{% else %}text-muted{% endif %}">
                                            {{ "%.2f"|format(row.pinned_ctr) }}%
                                        </span>
                                        {% else %}<span class="text-muted">-</span>{% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if row.thumbnail_ctr > 0 %}
                                        <span class="{% if row.thumbnail_ctr >= 5 %}text-success fw-bold{% elif row.thumbnail_ctr >= 2 %}text-body{% else %}text-muted{% endif %}">
                                            {{ "%.2f"|format(row.thumbnail_ctr) }}%
                                        </span>
                                        {% else %}<span class="text-muted">-</span>{% endif %}
                                    </td>
                                    <td class="text-center text-muted"><small>N/A</small></td>
                                    <td>
                                        {% if row.description %}
                                        <span class="desc-preview" tabindex="0"
                                              data-bs-toggle="popover"
                                              data-bs-trigger="focus"
                                              data-bs-placement="left"
                                              data-bs-content="{{ row.description[:500]|e }}"
                                              style="cursor:pointer; font-size:0.78rem;">
                                            {{ row.description[:80] }}{% if row.description|length > 80 %}...{% endif %}
                                        </span>
                                        {% else %}<span class="text-muted">-</span>{% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="p-3">
                        <nav aria-label="Audit pagination">
                            <ul class="pagination justify-content-center mb-0">
                                {% if page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('dashboard.conversion_audit', page=page-1, channel=channel_code, keyword=keyword_search, silo=silo_filter, sort_by=sort_by, sort_dir=sort_dir) }}">
                                        Previous
                                    </a>
                                </li>
                                {% endif %}
                                <li class="page-item active">
                                    <span class="page-link">Page {{ page }}</span>
                                </li>
                                {% if has_more %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('dashboard.conversion_audit', page=page+1, channel=channel_code, keyword=keyword_search, silo=silo_filter, sort_by=sort_by, sort_dir=sort_dir) }}">
                                        Next
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% else %}
                    <div class="alert alert-info text-center m-3">
                        <i class="fas fa-info-circle"></i> No videos found matching your criteria.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    #auditTable thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        white-space: nowrap;
        font-size: 0.8rem;
        padding: 0.5rem 0.4rem;
    }
    #auditTable tbody td {
        font-size: 0.82rem;
        padding: 0.4rem;
        vertical-align: middle;
    }
    .sticky-col {
        position: sticky;
        left: 0;
        z-index: 1;
        background: inherit;
    }
    thead .sticky-col {
        z-index: 3;
    }
    tr:hover .sticky-col {
        background: #f8f9fa;
    }
</style>

<script>
    // Initialize description popovers
    document.querySelectorAll('.desc-preview').forEach(function(el) {
        new bootstrap.Popover(el, { html: false, sanitize: true });
    });

    // Live filter on dropdown change
    document.getElementById('channel').addEventListener('change', function() {
        this.closest('form').submit();
    });
    document.getElementById('silo').addEventListener('change', function() {
        this.closest('form').submit();
    });

    // Debounced keyword search
    let searchTimeout = null;
    document.getElementById('keyword').addEventListener('input', function() {
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => { this.closest('form').submit(); }, 600);
    });
</script>
{% endblock %}
