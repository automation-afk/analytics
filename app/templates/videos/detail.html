{% extends "base.html" %}

{% block title %}{{ video.title }} - YouTube Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Video Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2">{{ video.title }}</h1>
                    <p class="text-muted mb-0">
                        <span class="badge bg-secondary">{{ video.channel_code }}</span>
                        <span class="ms-2">Published: {{ video.published_date.strftime('%Y-%m-%d') if video.published_date else 'N/A' }}</span>
                        <span class="ms-2">ID: {{ video.video_id }}</span>
                    </p>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="{{ video.video_url }}" target="_blank" class="btn btn-danger">
                        <i class="fab fa-youtube me-1"></i> Watch on YouTube
                    </a>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#transcribeModal" {% if is_transcribing %}disabled{% endif %}>
                        <i class="fas fa-microphone me-1"></i> Transcribe & Analyze
                    </button>
                    {% set has_analysis = script_analysis or description_analysis or conversion_analysis %}
                    <button type="button" class="btn btn-primary" id="reanalyzeBtn" data-bs-toggle="modal" data-bs-target="#reanalyzeModal" {% if is_analyzing %}disabled{% endif %}>
                        <i class="fas fa-brain me-1"></i> {% if has_analysis %}Re-analyze{% else %}Analyze{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Transcription In Progress Banner -->
    {% if is_transcribing %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success d-flex align-items-center" role="alert">
                <div class="spinner-border spinner-border-sm me-3" role="status">
                    <span class="visually-hidden">Transcribing...</span>
                </div>
                <div class="flex-grow-1">
                    <strong><i class="fas fa-microphone fa-pulse"></i> Transcription in Progress</strong>
                    <p class="mb-0">Video transcription and analysis is currently running. This may take several minutes. This page will auto-refresh when complete.</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Performance Metrics -->
    {% if revenue_metrics %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body" style="cursor:help;" data-bs-toggle="tooltip" data-bs-html="true" title="<b>Total Revenue</b><br>Sum of all affiliate revenue for this video.<br>Source: BigQuery Revenue_Metrics table (all-time).">
                    <h6 class="text-muted">Revenue</h6>
                    <h3 class="text-success">{{ revenue_metrics.revenue | format_currency }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body" style="cursor:help;" data-bs-toggle="tooltip" data-bs-html="true" title="<b>Total Clicks</b><br>Sum of all affiliate link clicks tracked.<br>Source: BigQuery Revenue_Metrics table.">
                    <h6 class="text-muted">Clicks</h6>
                    <h3 class="text-primary">{{ revenue_metrics.clicks | format_number }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body" style="cursor:help;" data-bs-toggle="tooltip" data-bs-html="true" title="<b>Total Sales</b><br>Completed purchases attributed to this video's affiliate links.<br>Source: BigQuery Revenue_Metrics table.">
                    <h6 class="text-muted">Sales</h6>
                    <h3 class="text-info">{{ revenue_metrics.sales | format_number }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body" style="cursor:help;" data-bs-toggle="tooltip" data-bs-html="true" title="<b>Organic Views</b><br>Total organic video views.<br>Source: BigQuery YT_Video_Registration_V2 table.">
                    <h6 class="text-muted">Views</h6>
                    <h3 class="text-warning">{{ revenue_metrics.organic_views | format_number }}</h3>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Video Description -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Video Description</h5>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    {% set description_text = video.description or (transcript_data.description if transcript_data else None) %}
                    {% if description_text %}
                    <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">{{ description_text }}</pre>
                    {% else %}
                    <div class="alert alert-secondary mb-0">
                        <i class="fas fa-info-circle"></i> No description available. Run "Transcribe & Analyze" to fetch from YouTube.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SCRIPT SCORE (New Scoring System) ==================== -->
    {% if script_score %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" id="scriptScoreCard">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-check"></i> Script Score
                        {% if script_score.all_gates_passed %}
                        <span class="badge bg-success ms-2">Gates: PASS</span>
                        {% else %}
                        <span class="badge bg-danger ms-2">Gates: FAIL</span>
                        {% endif %}
                        {% if script_score.quality_score_total is not none %}
                        <span class="badge {% if script_score.quality_score_total >= 80 %}bg-success{% elif script_score.quality_score_total >= 60 %}bg-warning text-dark{% else %}bg-danger{% endif %} ms-1">
                            {{ "%.0f"|format(script_score.quality_score_total) }}/100
                        </span>
                        {% endif %}
                        {% if script_score.multiplied_score is not none %}
                        <span class="badge bg-info ms-1" title="Quality Score x Context Multiplier">
                            Weighted: {{ "%.0f"|format(script_score.multiplied_score) }}
                        </span>
                        {% endif %}
                    </h5>
                    <button class="btn btn-sm btn-outline-light" onclick="openDetailModal('scriptScoreCard', 'Script Score', 'bg-dark', 'fas fa-clipboard-check')">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                </div>
                <div class="card-body" id="scriptScoreCard-card-body">
                    <div class="row">
                        <!-- Gate Checks -->
                        <div class="col-md-3">
                            <h6 class="fw-bold mb-2"><i class="fas fa-shield-alt me-1"></i> Gate Checks</h6>
                            <table class="table table-sm table-borderless mb-0">
                                <tbody>
                                {% for gate in script_score.gates %}
                                <tr>
                                    <td class="py-1" style="width: 24px;">
                                        {% if gate.passed %}
                                        <i class="fas fa-check-circle text-success"></i>
                                        {% else %}
                                        <i class="fas fa-times-circle text-danger"></i>
                                        {% endif %}
                                    </td>
                                    <td class="py-1">
                                        <span {% if gate.failure_reason %}data-bs-toggle="tooltip" data-bs-placement="right" title="{{ gate.failure_reason }}"{% endif %}>
                                            {{ gate.gate_name }}
                                        </span>
                                        {% if not gate.passed and gate.failure_reason %}
                                        <br><small class="text-danger d-none d-lg-inline">{{ gate.failure_reason[:80] }}{% if gate.failure_reason|length > 80 %}...{% endif %}</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Quality Score Breakdown -->
                        <div class="col-md-5">
                            <h6 class="fw-bold mb-2" style="cursor:help;"
                                data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                                title="<b>Quality Score</b><br>Sum of 6 weighted dimensions (100 pts max).<br>Scored by Claude AI from transcript text.<br>Each dimension has sub-scores evaluated against specific criteria."><i class="fas fa-star me-1"></i> Quality Score: {{ "%.0f"|format(script_score.quality_score_total or 0) }}/100</h6>
                            {% set dimensions = [
                                ('Specificity & Proof', script_score.specificity_score, 25, 'primary', 'Sub-scores: Quantified Claims (0-5), Feature-Benefit Cascade (0-5), Proof Density (0-5), Generic Content Ratio (0-5), LLM Smell (0-5). Measures credibility depth and uniqueness of claims.'),
                                ('Conversion Architecture', script_score.conversion_arch_score, 20, 'success', 'Sub-scores: CTA Placement (0-5), Frame Control (0-5), Decisiveness (0-4), Risk Reversal (0-3), Cognitive Leakage (0-3). Measures how well the script drives toward action.'),
                                ('Retention Architecture', script_score.retention_arch_score, 20, 'info', 'Sub-scores: Hook Specificity (0-5), Payoff Timing (0-4), Chapter Quality (0-4), Section Ordering (0-4), Reveal Quality (0-3). Measures viewer engagement structure.'),
                                ('Authenticity & Voice', script_score.authenticity_score, 15, 'warning', 'Sub-scores: Personal Anecdote (0-4), Personality Moments (0-4), Natural Language (0-3), LLM Voice (0-2), Survivability 2030 (0-2). Measures human authenticity.'),
                                ('Viewer Respect', script_score.viewer_respect_score, 10, 'secondary', 'Sub-scores: Cognitive Load (0-3), Funnel Depth (0-3), Insider Knowledge (0-2), Reddit Skeptic (0-2). Measures viewer sophistication respect.'),
                                ('Production Standards', script_score.production_score, 10, 'dark', 'Sub-scores: B-Roll References (0-4), Visual Evidence (0-3), Screen Hygiene (0-3). Measures production quality signals from transcript.'),
                            ] %}
                            {% for name, score, max_val, color, tooltip_text in dimensions %}
                            <div class="mb-1" style="cursor:help;"
                                data-bs-toggle="tooltip" data-bs-placement="right" data-bs-html="true"
                                title="<b>{{ name }} ({{ '%.0f'|format(score or 0) }}/{{ max_val }})</b><br>{{ tooltip_text }}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">{{ name }}</small>
                                    <small class="fw-bold">{{ "%.0f"|format(score or 0) }}/{{ max_val }}</small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-{{ color }}" role="progressbar"
                                         style="width: {{ ((score or 0) / max_val * 100)|round }}%"
                                         aria-valuenow="{{ score or 0 }}" aria-valuemin="0" aria-valuemax="{{ max_val }}">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Context Multiplier + Action Items -->
                        <div class="col-md-4">
                            <!-- Context Multiplier -->
                            {% if script_score.context_multiplier is not none %}
                            <div class="mb-3 p-2 bg-light rounded">
                                <h6 class="fw-bold mb-1"><i class="fas fa-calculator me-1"></i> Context Multiplier</h6>
                                <div class="d-flex justify-content-between small" style="cursor:help;"
                                    data-bs-toggle="tooltip" data-bs-placement="left" data-bs-html="true"
                                    title="<b>Keyword Tier</b><br>Determined by silo category from Digibot_General_info.<br>Tier 1 (money silos) get higher multipliers, Tier 2 (informational) get lower.">
                                    <span>Keyword Tier:</span>
                                    <span class="fw-bold">{{ script_score.keyword_tier|default('N/A')|upper }}</span>
                                </div>
                                {% if script_score.domination_score is not none %}
                                <div class="d-flex justify-content-between small" style="cursor:help;"
                                    data-bs-toggle="tooltip" data-bs-placement="left" data-bs-html="true"
                                    title="<b>Rank Domination Score</b><br>= SUM(RankDominationScore) &times; 100 per keyword<br>Source: Rank_domination_score table (latest rank_date)<br>Uses 3-CTE deduplication pattern (dom_raw &rarr; dom_deduped &rarr; dom_scores).<br>Higher % = more SERP coverage for this keyword.">
                                    <span>Domination:</span>
                                    <span class="fw-bold">{{ "%.0f"|format(script_score.domination_score) }}%</span>
                                </div>
                                {% endif %}
                                <div class="d-flex justify-content-between small" style="cursor:help;"
                                    data-bs-toggle="tooltip" data-bs-placement="left" data-bs-html="true"
                                    title="<b>Context Multiplier</b><br>Based on keyword tier + domination score.<br>Tier1 + high dom (&ge;90%): 1.2x<br>Tier1 + mid dom (60-89%): 1.1x<br>Tier1 + low dom (&lt;60%): 1.0x<br>Tier2 + high dom: 1.0x<br>Tier2 + low dom: 0.9x">
                                    <span>Multiplier:</span>
                                    <span class="fw-bold">{{ script_score.context_multiplier }}x</span>
                                </div>
                                <div class="d-flex justify-content-between small" style="cursor:help;"
                                    data-bs-toggle="tooltip" data-bs-placement="left" data-bs-html="true"
                                    title="<b>Quality Floor</b><br>Minimum quality score required for this context bucket.<br>If quality score &lt; floor, the video needs improvement before the multiplier fully applies.{% if not script_score.passes_quality_floor %}<br><br><span class='text-danger'>⚠ Below quality floor!</span>{% endif %}">
                                    <span>Quality Floor:</span>
                                    <span class="fw-bold {% if not script_score.passes_quality_floor %}text-danger{% endif %}">
                                        {{ "%.0f"|format(script_score.quality_floor or 0) }}
                                        {% if not script_score.passes_quality_floor %}<i class="fas fa-exclamation-triangle"></i>{% endif %}
                                    </span>
                                </div>
                                <hr class="my-1">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-bold" style="cursor:help;"
                                        data-bs-toggle="tooltip" data-bs-placement="left" data-bs-html="true"
                                        title="<b>Weighted Score</b><br>= Quality Score &times; Context Multiplier<br>= {{ '%.0f'|format(script_score.quality_score_total or 0) }} &times; {{ script_score.context_multiplier }}x<br>= <b>{{ '%.0f'|format(script_score.multiplied_score or 0) }}</b>">Weighted Score:</span>
                                    <span class="fw-bold fs-5 {% if script_score.multiplied_score >= 80 %}text-success{% elif script_score.multiplied_score >= 60 %}text-warning{% else %}text-danger{% endif %}">
                                        {{ "%.0f"|format(script_score.multiplied_score or 0) }}
                                    </span>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Optimization Opportunity -->
                            {% if optimization_opportunity is not none %}
                            <div class="mb-3 p-2 bg-light rounded border border-warning">
                                <h6 class="fw-bold mb-1"><i class="fas fa-lightbulb text-warning me-1"></i> Optimization Opportunity</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold fs-4 {% if optimization_opportunity >= 100 %}text-danger{% elif optimization_opportunity >= 50 %}text-warning{% else %}text-success{% endif %}" style="cursor:help;"
                                        data-bs-toggle="tooltip" data-bs-placement="left" data-bs-html="true"
                                        title="<b>Optimization Opportunity</b><br>= (Revenue Potential - Current Revenue) &times; (100 - Quality Score) / 100<br>= (${{ '%.2f'|format(opt_opp_details.revenue_potential) }} - ${{ '%.2f'|format(opt_opp_details.current_revenue) }}) &times; (100 - {{ '%.0f'|format(opt_opp_details.quality_score) }}) / 100<br>= <b>${{ '%.2f'|format(optimization_opportunity) }}</b><br><br>Revenue Potential = best revenue for keyword '{{ opt_opp_details.keyword|e }}'{% if opt_opp_details.best_video_id %} ({{ opt_opp_details.best_video_id }}){% endif %}">
                                        ${{ "%.2f"|format(optimization_opportunity) }}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between small mt-1" style="cursor:help;"
                                    data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
                                    title="<b>Revenue Potential</b><br>= highest 90d avg monthly revenue earned by any video targeting keyword '{{ opt_opp_details.keyword|e }}'<br>Source: Metrics_by_Month (90d avg) + Digibot_General_info (keyword grouping)">
                                    <span>Rev Potential:</span>
                                    <span class="fw-bold">${{ "%.2f"|format(opt_opp_details.revenue_potential) }}</span>
                                </div>
                                <div class="d-flex justify-content-between small" style="cursor:help;"
                                    data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
                                    title="<b>Current Revenue</b><br>= this video's 90d avg monthly revenue<br>Source: Metrics_by_Month WHERE date >= 90 days ago">
                                    <span>Current Rev:</span>
                                    <span class="fw-bold">${{ "%.2f"|format(opt_opp_details.current_revenue) }}</span>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Rizz Score -->
                            {% if script_score.rizz_score is not none %}
                            <div class="mb-3 p-2 bg-light rounded border border-info">
                                <h6 class="fw-bold mb-1"><i class="fas fa-fire text-danger me-1"></i> Rizz Score</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold fs-4 {% if script_score.rizz_score >= 80 %}text-success{% elif script_score.rizz_score >= 60 %}text-warning{% elif script_score.rizz_score >= 40 %}text-body{% else %}text-danger{% endif %}" style="cursor:help;"
                                        data-bs-toggle="tooltip" data-bs-placement="left" data-bs-html="true"
                                        title="<b>Rizz Score</b><br>= 60% Vocal + 40% Copy<br>= ({{ '%.0f'|format(script_score.rizz_vocal_score or 0) }}/60 vocal) + ({{ '%.0f'|format(script_score.rizz_copy_score or 0) }}/40 copy)<br>= <b>{{ '%.0f'|format(script_score.rizz_score) }}/100</b><br><br>{% if script_score.rizz_score >= 80 %}Magnetic{% elif script_score.rizz_score >= 60 %}Solid{% elif script_score.rizz_score >= 40 %}Flat{% else %}Monotone{% endif %}">
                                        {{ "%.0f"|format(script_score.rizz_score) }}/100
                                    </span>
                                    <span class="badge {% if script_score.rizz_score >= 80 %}bg-success{% elif script_score.rizz_score >= 60 %}bg-warning text-dark{% elif script_score.rizz_score >= 40 %}bg-secondary{% else %}bg-danger{% endif %}">
                                        {% if script_score.rizz_score >= 80 %}Magnetic{% elif script_score.rizz_score >= 60 %}Solid{% elif script_score.rizz_score >= 40 %}Flat{% else %}Monotone{% endif %}
                                    </span>
                                </div>
                                <div class="progress mt-2" style="height: 12px;">
                                    <div class="progress-bar bg-danger" role="progressbar"
                                         style="width: {{ ((script_score.rizz_vocal_score or 0) / 100 * 100)|round }}%"
                                         data-bs-toggle="tooltip" data-bs-placement="top"
                                         title="Vocal: {{ '%.0f'|format(script_score.rizz_vocal_score or 0) }}/60 — Derived from Hume AI emotion data (conviction, consistency, CTA delta, pacing)">
                                    </div>
                                    <div class="progress-bar bg-warning" role="progressbar"
                                         style="width: {{ ((script_score.rizz_copy_score or 0) / 100 * 100)|round }}%"
                                         data-bs-toggle="tooltip" data-bs-placement="top"
                                         title="Copy: {{ '%.0f'|format(script_score.rizz_copy_score or 0) }}/40 — Derived from transcript text (personality, sentence variation, decisive language, first-person experience)">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between small mt-1">
                                    <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
                                        title="<b>Vocal Score (60% weight)</b><br>Sources: Hume AI emotion data<br>Sub-metrics: Conviction, Consistency, CTA Delta, Filler Density, Pacing Variation<br>Each scored 0-20, total raw 0-100, then &times; 0.60">
                                        Vocal: {{ "%.0f"|format(script_score.rizz_vocal_score or 0) }}/60
                                    </span>
                                    <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
                                        title="<b>Copy Score (40% weight)</b><br>Sources: Transcript text analysis<br>Sub-metrics: Personality Density, Sentence Variation, Decisive Language, First-Person Experience<br>Each scored 0-25, total raw 0-100, then &times; 0.40">
                                        Copy: {{ "%.0f"|format(script_score.rizz_copy_score or 0) }}/40
                                    </span>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Top 3 Action Items -->
                            {% if script_score.action_items %}
                            <h6 class="fw-bold mb-2"><i class="fas fa-tasks me-1"></i> Top Action Items</h6>
                            {% for item in script_score.action_items[:3] %}
                            <div class="mb-2 p-2 border-start border-3 {% if loop.index == 1 %}border-danger{% elif loop.index == 2 %}border-warning{% else %}border-info{% endif %} bg-light rounded-end">
                                <small class="text-muted d-block">{{ item.dimension|default('') }}</small>
                                <small class="fw-bold">{{ item.action|default('') }}</small>
                                {% if item.specific_detail %}
                                <small class="d-block text-muted d-none d-lg-block">{{ item.specific_detail[:120] }}{% if item.specific_detail|length > 120 %}...{% endif %}</small>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="text-end mt-2">
                        <small class="text-muted">Scored: {{ script_score.scored_at[:16] if script_score.scored_at else 'N/A' }} | v{{ script_score.scoring_version|default('1.0') }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Script Analysis (Legacy) -->
        <div class="col-md-6 mb-4">
            <div class="card h-100" id="scriptCard">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-alt"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-placement="bottom" title="AI-analyzed by Claude from the video transcript. Scores are 1-10 based on clarity, engagement, pacing, and persuasion techniques.">Script Quality Analysis</span> {% if script_score %}<span class="badge bg-light text-primary ms-1">Legacy</span>{% endif %}</h5>
                    {% if script_analysis %}
                    <button class="btn btn-sm btn-outline-light" onclick="openDetailModal('scriptCard', 'Script Quality Analysis', 'bg-primary', 'fas fa-file-alt')">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if script_analysis %}
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <h6 style="cursor:help;" data-bs-toggle="tooltip" title="Clarity, structure, pacing, and overall engagement of the script">Overall Quality</h6>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-success" role="progressbar"
                                             style="width: {{ (script_analysis.script_quality_score / 10 * 100)|int }}%">
                                            {{ "%.1f" | format(script_analysis.script_quality_score) }}/10
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <h6 style="cursor:help;" data-bs-toggle="tooltip" title="How well the opening 30 seconds captures attention and drives retention">Hook Effectiveness</h6>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-info" role="progressbar"
                                             style="width: {{ (script_analysis.hook_effectiveness_score / 10 * 100)|int }}%">
                                            {{ "%.1f" | format(script_analysis.hook_effectiveness_score) }}/10
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="row">
                                <div class="col-6">
                                    <h6 style="cursor:help;" data-bs-toggle="tooltip" title="Strength and clarity of viewer directives (subscribe, click, buy)">Call to Action</h6>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-warning" role="progressbar"
                                             style="width: {{ (script_analysis.call_to_action_score / 10 * 100)|int }}%">
                                            {{ "%.1f" | format(script_analysis.call_to_action_score) }}/10
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <h6 style="cursor:help;" data-bs-toggle="tooltip" title="Use of persuasion techniques: social proof, urgency, authority, and emotional triggers">Persuasion</h6>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-danger" role="progressbar"
                                             style="width: {{ (script_analysis.persuasion_effectiveness_score / 10 * 100)|int }}%">
                                            {{ "%.1f" | format(script_analysis.persuasion_effectiveness_score) }}/10
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% if script_analysis.key_strengths %}
                        <div class="mb-3">
                            <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-identified by Claude from transcript analysis. Highlights what the script does well in engaging viewers."><i class="fas fa-check-circle text-success"></i> Key Strengths:</h6>
                            <ul class="list-unstyled">
                                {% for strength in script_analysis.key_strengths %}
                                <li><i class="fas fa-arrow-right text-success me-2"></i>{{ strength }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        {% if script_analysis.improvement_areas %}
                        <div class="mb-3">
                            <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-identified by Claude. Areas where the script could be improved for better retention or conversions."><i class="fas fa-exclamation-triangle text-warning"></i> Improvement Areas:</h6>
                            <ul class="list-unstyled">
                                {% for area in script_analysis.improvement_areas %}
                                <li><i class="fas fa-arrow-right text-warning me-2"></i>{{ area }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        {% if script_analysis.persuasion_techniques %}
                        <div>
                            <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-detected by Claude. Techniques like social proof, scarcity, authority, reciprocity found in the script.">Persuasion Techniques Used:</h6>
                            <div>
                                {% for technique in script_analysis.persuasion_techniques %}
                                <span class="badge bg-secondary me-1 mb-1">{{ technique }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No script analysis available. Click "Re-analyze" to generate.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Affiliate Performance & Recommendations -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> Affiliate Performance</h5>
                    <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#affiliateModal">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                </div>
                <div class="card-body d-flex flex-column">
                    <!-- Inline Tabs -->
                    <ul class="nav nav-tabs nav-sm mb-3" id="affInlineTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active py-1 px-2" id="aff-perf-tab" data-bs-toggle="tab" data-bs-target="#aff-perf" type="button" role="tab">
                                <i class="fas fa-chart-bar me-1"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-trigger="hover" title="Actual revenue data from BigQuery affiliate tracking (not AI-generated)">BigQuery Data</span>
                                {% if affiliate_performance %}<span class="badge bg-success ms-1 small">{{ affiliate_performance|length }}</span>{% endif %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link py-1 px-2" id="aff-links-tab" data-bs-toggle="tab" data-bs-target="#aff-links" type="button" role="tab">
                                <i class="fas fa-link me-1"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-trigger="hover" title="URLs extracted from description using pattern matching. Affiliate detection based on URL shorteners, tracking params, and known networks.">Links</span>
                                {% if existing_links %}<span class="badge bg-info ms-1 small">{{ existing_links.total_links }}</span>{% endif %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link py-1 px-2" id="aff-ai-tab" data-bs-toggle="tab" data-bs-target="#aff-ai" type="button" role="tab">
                                <i class="fas fa-robot me-1"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-trigger="hover" title="AI-generated product recommendations by Claude based on video content, audience, and real performance data when available.">AI</span>
                                {% if affiliate_recs %}<span class="badge bg-warning text-dark ms-1 small">{{ affiliate_recs|length }}</span>{% endif %}
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content flex-grow-1 overflow-hidden" id="affInlineTabContent">
                        <!-- Real Performance Tab -->
                        <div class="tab-pane fade show active h-100" id="aff-perf" role="tabpanel" style="overflow-y: auto;">
                            {% if affiliate_performance %}
                                {% set total_rev = affiliate_performance | map(attribute='total_revenue') | sum %}
                                {% set total_clicks = affiliate_performance | map(attribute='total_clicks') | sum %}
                                {% set total_sales = affiliate_performance | map(attribute='total_sales') | sum %}
                                <div class="row text-center mb-2">
                                    <div class="col-4">
                                        <small class="text-muted d-block">Revenue</small>
                                        <strong class="text-success">${{ "%.2f" | format(total_rev) }}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">Clicks</small>
                                        <strong>{{ total_clicks }}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">Sales</small>
                                        <strong>{{ total_sales }}</strong>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0 small">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Affiliate</th>
                                                <th class="text-end">Revenue</th>
                                                <th class="text-end">Clicks</th>
                                                <th class="text-end">Conv%</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for perf in affiliate_performance[:5] %}
                                            <tr>
                                                <td class="text-truncate" style="max-width: 150px;">
                                                    <strong>{{ perf.affiliate }}</strong>
                                                    <br><small class="text-muted">{{ perf.link_placement }}</small>
                                                </td>
                                                <td class="text-end text-success fw-bold text-nowrap">${{ "%.2f" | format(perf.total_revenue) }}</td>
                                                <td class="text-end">{{ perf.total_clicks }}</td>
                                                <td class="text-end">{{ "%.1f" | format(perf.conversion_rate) }}%</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% if affiliate_performance|length > 5 %}
                                <small class="text-muted mt-2 d-block">+ {{ affiliate_performance|length - 5 }} more — click <i class="fas fa-expand-alt"></i> to expand</small>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle"></i> No tracking data in BigQuery.
                                </div>
                            {% endif %}
                        </div>

                        <!-- Existing Links Tab -->
                        <div class="tab-pane fade h-100" id="aff-links" role="tabpanel" style="overflow-y: auto;">
                            {% if existing_links and existing_links.links %}
                                <div class="row text-center mb-2">
                                    <div class="col-4">
                                        <small class="text-muted d-block">Total</small>
                                        <strong>{{ existing_links.total_links }}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">Affiliate</small>
                                        <strong class="text-success">{{ existing_links.affiliate_links }}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">Disclosure</small>
                                        {% if existing_links.has_affiliate_disclosure %}
                                            <strong class="text-success"><i class="fas fa-check"></i></strong>
                                        {% else %}
                                            <strong class="text-danger"><i class="fas fa-times"></i></strong>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="list-group list-group-flush">
                                    {% for link in existing_links.links[:8] %}
                                    <div class="list-group-item px-0 py-1">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <a href="{{ link.url }}" target="_blank" rel="noopener" class="small text-truncate" style="max-width: 250px;">{{ link.url }}</a>
                                            <div>
                                                <span class="badge bg-secondary small">{{ link.platform }}</span>
                                                {% if link.is_affiliate %}<span class="badge bg-success small">Aff</span>{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% if existing_links.links|length > 8 %}
                                <small class="text-muted mt-1 d-block">+ {{ existing_links.links|length - 8 }} more — click <i class="fas fa-expand-alt"></i> to expand</small>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle"></i> No links found in description.
                                </div>
                            {% endif %}
                        </div>

                        <!-- AI Suggestions Tab -->
                        <div class="tab-pane fade h-100" id="aff-ai" role="tabpanel" style="overflow-y: auto;">
                            {% if affiliate_recs %}
                                <div class="list-group list-group-flush">
                                    {% for rec in affiliate_recs[:5] %}
                                    <div class="list-group-item px-0 py-2">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <strong class="small">{{ rec.product_rank }}. {{ rec.product_name }}</strong>
                                                {% if rec.mentioned_in_video %}<span class="badge bg-info ms-1 small">In video</span>{% endif %}
                                                <br><small class="text-muted">{{ rec.product_category }}</small>
                                            </div>
                                            <div class="text-end ms-2">
                                                <span class="badge bg-success small">{{ "%.0f" | format(rec.relevance_score * 100) }}%</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <small class="text-muted"><i class="fas fa-robot me-1"></i>AI-generated — click <i class="fas fa-expand-alt"></i> for full info</small>
                            {% else %}
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle"></i> No AI recommendations. Re-analyze with Affiliate enabled.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Description Analysis -->
        <div class="col-md-6 mb-4">
            <div class="card h-100" id="descriptionCard">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-align-left"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-placement="bottom" title="AI-analyzed by Claude. Evaluates description quality, SEO optimization, and CTA effectiveness. Traffic data is from YouTube Analytics API.">Description CTR Analysis</span></h5>
                    {% if description_analysis %}
                    <button class="btn btn-sm btn-outline-light" onclick="openDetailModal('descriptionCard', 'Description CTR Analysis', 'bg-info', 'fas fa-align-left')">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                    {% endif %}
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {# Show Impression CTR from YT Analytics at top #}
                    {% if revenue_metrics and revenue_metrics.impression_ctr %}
                    <div class="alert alert-light mb-3 py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-mouse-pointer text-info me-2"></i><strong>Impression CTR:</strong></span>
                            <span class="badge bg-info fs-6">{{ "%.2f" | format(revenue_metrics.impression_ctr) }}%</span>
                        </div>
                        <small class="text-muted">From YouTube Analytics (avg across all impressions)</small>
                    </div>
                    {% endif %}

                    {% if description_analysis %}
                        <div class="row mb-3">
                            <div class="col-4 text-center">
                                <h6 style="cursor:help;" data-bs-toggle="tooltip" title="Formatting, readability, completeness, and link organization">Quality Score</h6>
                                <h3 class="text-primary">{{ "%.1f" | format(description_analysis.description_quality_score) }}/10</h3>
                            </div>
                            <div class="col-4 text-center">
                                <h6 style="cursor:help;" data-bs-toggle="tooltip" title="Strength of call-to-action elements that drive clicks and engagement">CTA Score</h6>
                                <h3 class="text-success">{{ "%.1f" | format(description_analysis.cta_effectiveness_score) }}/10</h3>
                            </div>
                            <div class="col-4 text-center">
                                <h6 style="cursor:help;" data-bs-toggle="tooltip" title="Keyword usage, discoverability, and search optimization quality">SEO Score</h6>
                                <h3 class="text-info">{{ "%.1f" | format(description_analysis.seo_score) }}/10</h3>
                            </div>
                        </div>

                        {# YT Analytics Traffic Source Data #}
                        {% if description_analysis.yt_by_traffic_source %}
                        <div class="mb-3">
                            <h6 style="cursor:help;" data-bs-toggle="tooltip" title="Source: YouTube Analytics API. Shows views, CTR, and avg watch % by traffic source (search, browse, suggested, etc.) over the last 90 days."><i class="fas fa-chart-pie text-primary"></i> Traffic Sources (Last 90 Days)</h6>
                            <div class="small">
                                <div class="d-flex justify-content-between text-muted mb-1">
                                    <span>Total Views: <strong>{{ description_analysis.yt_total_views | format_number }}</strong></span>
                                    <span>Impressions: <strong>{{ description_analysis.yt_total_impressions | format_number }}</strong></span>
                                    <span>Overall CTR: <strong>{{ "%.2f" | format(description_analysis.yt_overall_ctr) }}%</strong></span>
                                </div>
                                {% if description_analysis.main_keyword %}
                                <div class="text-muted mb-2">
                                    <i class="fas fa-key"></i> Keyword: <strong>{{ description_analysis.main_keyword }}</strong>
                                    {% if description_analysis.silo %} | Silo: {{ description_analysis.silo }}{% endif %}
                                </div>
                                {% endif %}
                                <table class="table table-sm table-bordered mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Traffic Source</th>
                                            <th class="text-end">Views</th>
                                            <th class="text-end">CTR</th>
                                            <th class="text-end">Avg Watch</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for source in description_analysis.yt_by_traffic_source[:5] %}
                                        <tr>
                                            <td>{{ source.traffic_source }}</td>
                                            <td class="text-end">{{ source.views | format_number }}</td>
                                            <td class="text-end">{{ "%.2f" | format(source.avg_ctr) }}%</td>
                                            <td class="text-end">{{ "%.1f" | format(source.avg_view_percentage) }}%</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <p class="mb-1"><strong>Total Links:</strong> {{ description_analysis.total_links }}</p>
                            <p class="mb-1"><strong>Affiliate Links:</strong> {{ description_analysis.affiliate_links }}</p>
                        </div>

                        {% if description_analysis.strengths %}
                        <div class="mb-3">
                            <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-identified by Claude. What the description does well for SEO, CTR, and viewer engagement."><i class="fas fa-check-circle text-success"></i> Strengths:</h6>
                            <ul class="mb-0">
                                {% for strength in description_analysis.strengths %}
                                <li>{{ strength }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        {% if description_analysis.missing_elements %}
                        <div class="mb-3">
                            <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-identified by Claude. Key elements absent from the description that could improve discoverability and clicks."><i class="fas fa-exclamation-circle text-danger"></i> Missing Elements:</h6>
                            <ul class="mb-0">
                                {% for element in description_analysis.missing_elements %}
                                <li>{{ element }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        {% if description_analysis.optimization_suggestions %}
                        <div>
                            <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-generated by Claude. Actionable recommendations to improve the description for better CTR and SEO performance."><i class="fas fa-lightbulb text-warning"></i> Optimization Suggestions:</h6>
                            <ul class="mb-0">
                                {% for suggestion in description_analysis.optimization_suggestions %}
                                <li>{{ suggestion }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No description analysis available.
                            {% if not video.description %}
                            <br><small class="text-warning"><i class="fas fa-exclamation-triangle"></i> This video has no description. Run "Transcribe & Analyze" first to fetch from YouTube.</small>
                            {% else %}
                            Click "Re-analyze" to generate.
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Conversion Analysis -->
        <div class="col-md-6 mb-4">
            <div class="card h-100" id="conversionCard">
                <div class="card-header bg-warning d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Rates calculated from BigQuery revenue data + YouTube Analytics views. Drivers and recommendations are AI-generated by Claude.">Conversion Analysis</span></h5>
                    {% if conversion_analysis %}
                    <button class="btn btn-sm btn-outline-dark" onclick="openDetailModal('conversionCard', 'Conversion Analysis', 'bg-warning text-dark', 'fas fa-chart-line')">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                    {% endif %}
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {# Use conversion_analysis if available, otherwise compute from revenue_metrics #}
                    {% set conv_rate = conversion_analysis.conversion_rate if conversion_analysis and conversion_analysis.conversion_rate else (revenue_metrics.conversion_rate if revenue_metrics else 0) %}
                    {% set rev_per_click = conversion_analysis.revenue_per_click if conversion_analysis and conversion_analysis.revenue_per_click else (revenue_metrics.revenue_per_click if revenue_metrics else 0) %}
                    {# Calculate click-to-sale rate #}
                    {% set click_to_sale = (revenue_metrics.sales / revenue_metrics.clicks * 100) if revenue_metrics and revenue_metrics.clicks > 0 else 0 %}

                    <div class="row mb-3">
                        <div class="col-6 text-center">
                            <h6 style="cursor:help;" data-bs-toggle="tooltip" title="BigQuery: (total sales / total views) × 100">Views → Sales</h6>
                            <h3 class="text-success">{{ "%.3f" | format(conv_rate) }}%</h3>
                            <small class="text-muted">Conversion Rate</small>
                        </div>
                        <div class="col-6 text-center">
                            <h6 style="cursor:help;" data-bs-toggle="tooltip" title="BigQuery: (total sales / total affiliate clicks) × 100">Clicks → Sales</h6>
                            <h3 class="text-info">{{ "%.1f" | format(click_to_sale) }}%</h3>
                            <small class="text-muted">Click-to-Sale Rate</small>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6 text-center">
                            <h6 style="cursor:help;" data-bs-toggle="tooltip" title="BigQuery: total revenue / total affiliate clicks">Revenue/Click</h6>
                            <h3 class="text-primary">{{ rev_per_click | format_currency }}</h3>
                        </div>
                        <div class="col-6 text-center">
                            <h6 style="cursor:help;" data-bs-toggle="tooltip" title="BigQuery: (total revenue / total views) × 1000">Revenue/1K Views</h6>
                            <h3 class="text-warning">{{ (revenue_metrics.revenue_per_1k_views if revenue_metrics else 0) | format_currency }}</h3>
                        </div>
                    </div>

                    {% if conversion_analysis and conversion_analysis.conversion_drivers %}
                    <div class="mb-3">
                        <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-identified by Claude. Factors in the video content that contribute to converting viewers into buyers."><i class="fas fa-rocket text-success"></i> Conversion Drivers:</h6>
                        <ul class="mb-0">
                            {% for driver in conversion_analysis.conversion_drivers %}
                            <li>{{ driver }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if conversion_analysis and conversion_analysis.underperformance_reasons %}
                    <div class="mb-3">
                        <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-identified by Claude using BigQuery revenue data + video content. Explains why conversions may be lower than expected."><i class="fas fa-exclamation-triangle text-danger"></i> Underperformance Reasons:</h6>
                        <ul class="mb-0">
                            {% for reason in conversion_analysis.underperformance_reasons %}
                            <li>{{ reason }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if conversion_analysis and conversion_analysis.recommendations %}
                    <div>
                        <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-generated by Claude. Actionable steps to improve conversion rates based on real performance data and content analysis."><i class="fas fa-star text-warning"></i> Recommendations:</h6>
                        <ul class="mb-0">
                            {% for rec in conversion_analysis.recommendations %}
                            <li>{{ rec }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% elif not conversion_analysis %}
                    <div class="alert alert-secondary">
                        <i class="fas fa-info-circle"></i> Click "Re-analyze" to get AI-powered conversion insights.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Transcript & Emotions -->
    {% if transcript_data %}
    <div class="row">
        <!-- Transcript Info -->
        <div class="col-md-6 mb-4">
            <div class="card h-100" id="transcriptCard">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-audio"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Speech-to-text by Groq Whisper AI. Audio is downloaded, transcribed, then deleted. Segments contain word-level timestamps.">Transcript</span></h5>
                    <button class="btn btn-sm btn-outline-light" onclick="openDetailModal('transcriptCard', 'Transcript', 'bg-dark', 'fas fa-file-audio')">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <span class="badge bg-info me-2">{{ transcript_data.word_count }} words</span>
                        <span class="badge bg-secondary me-2">{{ transcript_data.provider }}</span>
                        {% if transcript_data.duration_seconds %}
                        <span class="badge bg-warning">{{ (transcript_data.duration_seconds / 60)|int }} min</span>
                        {% endif %}
                        <span class="small text-muted" style="cursor:help;" data-bs-toggle="tooltip" title="Word count calculated from transcript text. Provider is the speech-to-text engine (Groq Whisper). Duration from audio file metadata.">(hover for details)</span>
                    </div>

                    {% if transcript_data.segments %}
                    <!-- Tabs for Full Text vs With Timestamps -->
                    <ul class="nav nav-tabs nav-sm mb-3" id="transcriptTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active py-1 px-2" id="fulltext-tab" data-bs-toggle="tab" data-bs-target="#transcript-fulltext" type="button" role="tab">
                                <i class="fas fa-align-left me-1"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-trigger="hover" title="Complete transcript text generated by Groq Whisper AI from the video audio.">Full Text</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link py-1 px-2" id="timestamps-tab" data-bs-toggle="tab" data-bs-target="#transcript-timestamps" type="button" role="tab">
                                <i class="fas fa-clock me-1"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-trigger="hover" title="Transcript segments with start times from Groq Whisper. Each row is a speech segment with its timestamp in seconds.">With Timestamps</span>
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="transcriptTabContent">
                        <!-- Full Text Tab -->
                        <div class="tab-pane fade show active" id="transcript-fulltext" role="tabpanel">
                            <div style="max-height: 250px; overflow-y: auto;">
                                <p class="small" style="white-space: pre-wrap;">{{ transcript_data.transcript }}</p>
                            </div>
                        </div>

                        <!-- Timestamps Tab -->
                        <div class="tab-pane fade" id="transcript-timestamps" role="tabpanel">
                            <div style="max-height: 250px; overflow-y: auto;">
                                <table class="table table-sm table-hover small mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width: 70px;">Time</th>
                                            <th>Text</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for segment in transcript_data.segments %}
                                        <tr>
                                            <td class="text-nowrap">
                                                <span class="badge bg-secondary">{{ "%.1f" | format(segment.start) }}s</span>
                                            </td>
                                            <td>{{ segment.text }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- No segments - just show full text -->
                    <div style="max-height: 300px; overflow-y: auto;">
                        <p class="small" style="white-space: pre-wrap;">{{ transcript_data.transcript }}</p>
                    </div>
                    <div class="small text-muted mt-2">
                        <i class="fas fa-info-circle"></i> To view with timestamps, re-run Transcribe with "Store segments" enabled.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Emotion Analysis -->
        <div class="col-md-6 mb-4">
            <div class="card h-100" id="emotionCard">
                <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #6f42c1;">
                    <h5 class="mb-0"><i class="fas fa-smile"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Voice prosody analyzed by Hume AI. Scores represent confidence (0-100%) that each emotion is present in speech.">Voice Emotion Analysis</span></h5>
                    {% if transcript_data.emotions and transcript_data.emotions.summary %}
                    <button class="btn btn-sm btn-outline-light" onclick="openDetailModal('emotionCard', 'Voice Emotion Analysis', '', 'fas fa-smile')" style="border-color: rgba(255,255,255,.5); color: white;">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if transcript_data.emotions and transcript_data.emotions.summary %}
                        <div class="mb-3">
                            <span class="badge bg-info">{{ transcript_data.emotions.total_segments }} segments analyzed</span>
                            <span class="badge bg-secondary">{{ transcript_data.emotions.summary|length }} emotions detected</span>
                            <span class="small text-muted" style="cursor:help;" data-bs-toggle="tooltip" title="Audio split into segments and analyzed by Hume AI voice prosody model. Each segment is scored for multiple emotions (0-100% confidence).">(hover for details)</span>
                        </div>

                        <!-- Tabs for Summary vs Timeline -->
                        <ul class="nav nav-tabs nav-sm mb-3" id="emotionTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active py-1 px-2" id="summary-tab" data-bs-toggle="tab" data-bs-target="#emotion-summary" type="button" role="tab">
                                    <i class="fas fa-chart-bar me-1"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-trigger="hover" title="Average confidence score per emotion across all segments. Occurrences = how many segments detected that emotion. Source: Hume AI.">Summary</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link py-1 px-2" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#emotion-timeline" type="button" role="tab">
                                    <i class="fas fa-clock me-1"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-trigger="hover" title="Per-segment emotion breakdown over time. Shows the top 3 emotions detected in each audio segment with their confidence scores. Source: Hume AI.">Timeline</span>
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="emotionTabContent">
                            <!-- Summary Tab -->
                            <div class="tab-pane fade show active" id="emotion-summary" role="tabpanel">
                                <div style="max-height: 220px; overflow-y: auto;">
                                    {% for emo in transcript_data.emotions.summary %}
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between">
                                            <span>{{ emo.emotion }}</span>
                                            <span class="text-muted">{{ "%.0f" | format(emo.average_score * 100) }}% <small>({{ emo.occurrences }}x)</small></span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-primary" role="progressbar"
                                                 style="width: {{ (emo.average_score * 100)|int }}%"></div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Timeline Tab -->
                            <div class="tab-pane fade" id="emotion-timeline" role="tabpanel">
                                <div style="max-height: 220px; overflow-y: auto;">
                                    {% if transcript_data.emotions.segments %}
                                    <table class="table table-sm table-hover small mb-0">
                                        <thead>
                                            <tr>
                                                <th style="width: 80px;">Time</th>
                                                <th>Top Emotions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for seg in transcript_data.emotions.segments %}
                                            <tr>
                                                <td class="text-muted">
                                                    {{ "%.1f" | format(seg.start) }}s
                                                </td>
                                                <td>
                                                    {% for emo in seg.top_emotions[:3] %}
                                                    <span class="badge bg-{% if loop.index == 1 %}primary{% elif loop.index == 2 %}secondary{% else %}light text-dark{% endif %} me-1">
                                                        {{ emo.emotion }} {{ "%.0f" | format(emo.score * 100) }}%
                                                    </span>
                                                    {% endfor %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    {% else %}
                                    <p class="text-muted">No timeline data available.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-secondary">
                            <i class="fas fa-info-circle"></i> No emotion analysis available. Re-transcribe with emotions enabled.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Frame Analysis -->
    {% if transcript_data.frame_analysis %}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card" id="frameCard">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-images"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Video frames extracted at intervals and analyzed by Claude Vision AI for scene description, on-screen text, and object detection.">Frame Analysis</span></h5>
                    <div>
                        <span class="badge bg-light text-dark me-2">{{ transcript_data.frame_analysis|length }} frames</span>
                        <button class="btn btn-sm btn-outline-light" onclick="openDetailModal('frameCard', 'Frame Analysis', 'bg-secondary', 'fas fa-images')">
                            <i class="fas fa-expand-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <div class="row">
                        {% for frame in transcript_data.frame_analysis %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header py-2">
                                    <strong>{{ frame.timestamp }}s</strong>
                                </div>
                                <div class="card-body py-2">
                                    <p class="card-text small mb-2"><strong class="text-secondary" style="cursor:help;" data-bs-toggle="tooltip" title="Scene description generated by Claude Vision AI analyzing the extracted video frame image.">Scene:</strong> {{ frame.scene if frame.scene else 'No description' }}</p>
                                    {% if frame.text_on_screen %}
                                    <div class="small">
                                        <strong class="text-warning" style="cursor:help;" data-bs-toggle="tooltip" title="On-screen text detected by Claude Vision AI (OCR) from the video frame.">Text:</strong> {{ frame.text_on_screen }}
                                    </div>
                                    {% endif %}
                                    {% if frame.objects %}
                                    <div class="small mt-1">
                                        <strong class="text-info" style="cursor:help;" data-bs-toggle="tooltip" title="Visual objects and elements identified by Claude Vision AI in the video frame.">Objects:</strong> {{ frame.objects }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- AI Content Insights (Multimodal Analysis) -->
    {% if transcript_data %}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card border-primary" id="insightsCard">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0"><i class="fas fa-lightbulb"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Generated by Claude AI combining transcript text, voice emotion data, and visual frame analysis into comprehensive content insights.">AI Content Insights</span></h5>
                        <small class="opacity-75">Combined analysis of transcript, emotions, and visuals</small>
                    </div>
                    {% if transcript_data.content_insights %}
                    <button class="btn btn-sm btn-outline-light" onclick="openDetailModal('insightsCard', 'AI Content Insights', 'bg-primary', 'fas fa-lightbulb')">
                        <i class="fas fa-expand-alt"></i>
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if transcript_data.content_insights %}
                    {% set insights = transcript_data.content_insights %}

                    {# Summary Row #}
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-generated by Claude combining transcript, voice emotions (Hume AI), and frame analysis (Claude Vision) into a comprehensive summary."><i class="fas fa-file-alt text-primary"></i> Content Summary</h6>
                            <p class="mb-2" style="line-height: 1.6;">{{ insights.content_summary or 'Not available' }}</p>
                            <div class="alert alert-light border-start border-primary border-3 py-2 mb-0">
                                <strong style="cursor:help;" data-bs-toggle="tooltip" title="The single most important message from the video, as identified by Claude AI from transcript analysis."><i class="fas fa-bullseye"></i> Key Takeaway:</strong> {{ insights.key_takeaway or 'Not available' }}
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="card bg-light">
                                <div class="card-body py-3">
                                    <h6 class="text-muted mb-1" style="cursor:help;" data-bs-toggle="tooltip" title="AI score (1-10) by Claude based on content quality, emotional delivery, visual variety, and audience relevance.">Engagement Score</h6>
                                    <h2 class="mb-1 {% if insights.engagement_score >= 7 %}text-success{% elif insights.engagement_score >= 5 %}text-warning{% else %}text-danger{% endif %}">
                                        {{ insights.engagement_score or 0 }}/10
                                    </h2>
                                    <small class="text-muted">{{ insights.content_type or 'Unknown' }} | {{ insights.predicted_audience or 'General' }}</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-3">

                    {# Emotional Arc & Visual Storytelling #}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card border-0 bg-light h-100">
                                <div class="card-body">
                                    <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI analysis by Claude using Hume AI emotion data. Describes how emotional tone shifts throughout the video."><i class="fas fa-heart text-danger"></i> Emotional Arc</h6>
                                    <p class="mb-0" style="line-height: 1.6;">{{ insights.emotional_arc or 'Not analyzed' }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 bg-light h-100">
                                <div class="card-body">
                                    <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI analysis by Claude using frame analysis data (Claude Vision). Describes how visuals support the narrative."><i class="fas fa-film text-info"></i> Visual Storytelling</h6>
                                    <p class="mb-0" style="line-height: 1.6;">{{ insights.visual_storytelling or 'Not analyzed' }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-3">

                    {# Key Moments #}
                    {% if insights.key_moments %}
                    <div class="mb-3">
                        <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-identified by Claude. Important moments in the video with timestamps, combining transcript content, emotional peaks, and visual changes."><i class="fas fa-star text-warning"></i> Key Moments</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 100px;">Time</th>
                                        <th>What Happens</th>
                                        <th>Why It Matters</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for moment in insights.key_moments[:5] %}
                                    <tr>
                                        <td><span class="badge bg-secondary">{{ moment.timestamp }}</span></td>
                                        <td>{{ moment.description }}</td>
                                        <td><em>{{ moment.significance }}</em></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <hr class="my-3">
                    {% endif %}

                    {# Strengths, Engagement Factors, Improvements #}
                    <div class="row">
                        <div class="col-md-4">
                            {% if insights.content_strengths %}
                            <div class="card border-success border-top border-0 h-100">
                                <div class="card-body pt-2">
                                    <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-identified by Claude from multimodal analysis (transcript + emotions + visuals). What the content does well."><i class="fas fa-check-circle text-success"></i> Strengths</h6>
                                    <ul class="mb-0">
                                        {% for strength in insights.content_strengths %}
                                        <li>{{ strength }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            {% if insights.audience_engagement_factors %}
                            <div class="card border-primary border-top border-0 h-100">
                                <div class="card-body pt-2">
                                    <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-identified by Claude. Elements that drive audience engagement based on content analysis and emotional delivery patterns."><i class="fas fa-users text-primary"></i> Engagement Factors</h6>
                                    <ul class="mb-0">
                                        {% for factor in insights.audience_engagement_factors %}
                                        <li>{{ factor }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            {% if insights.improvement_opportunities %}
                            <div class="card border-warning border-top border-0 h-100">
                                <div class="card-body pt-2">
                                    <h6 style="cursor:help;" data-bs-toggle="tooltip" title="AI-suggested by Claude. Areas where the content could be improved based on gaps identified in multimodal analysis."><i class="fas fa-arrow-up text-warning"></i> Improvement Opportunities</h6>
                                    <ul class="mb-0">
                                        {% for opp in insights.improvement_opportunities %}
                                        <li>{{ opp }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    {# No content insights yet #}
                    <div class="text-center py-4">
                        <i class="fas fa-lightbulb text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3 mb-0">No AI insights generated yet. Use "Transcribe & Analyze" with "Generate AI Content Insights" enabled.</p>
                        <p class="small text-muted">
                            Available data:
                            {% if transcript_data.transcript %}<span class="badge bg-success me-1">Transcript</span>{% endif %}
                            {% if transcript_data.emotions %}<span class="badge bg-info me-1">Emotions</span>{% endif %}
                            {% if transcript_data.frame_analysis %}<span class="badge bg-warning me-1">Frames</span>{% endif %}
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Back Button -->
    <div class="row">
        <div class="col-12">
            <a href="{{ url_for('dashboard.videos_list') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Videos
            </a>
        </div>
    </div>
</div>

<!-- Affiliate Details Modal -->
<div class="modal fade" id="affiliateModal" tabindex="-1" aria-labelledby="affiliateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="affiliateModalLabel">
                    <i class="fas fa-shopping-cart me-2"></i>Affiliate Performance & Recommendations
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs" id="affiliateTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="real-performance-tab" data-bs-toggle="tab"
                                data-bs-target="#real-performance" type="button" role="tab">
                            <i class="fas fa-chart-bar me-1"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-trigger="hover" title="Actual revenue data from BigQuery affiliate tracking (not AI-generated)">BigQuery Data</span>
                            {% if affiliate_performance %}
                            <span class="badge bg-success ms-1">{{ affiliate_performance|length }}</span>
                            {% endif %}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="existing-links-tab" data-bs-toggle="tab"
                                data-bs-target="#existing-links" type="button" role="tab">
                            <i class="fas fa-link me-1"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-trigger="hover" title="URLs extracted from description using pattern matching. Affiliate detection based on URL shorteners, tracking params, and known networks.">Existing Links</span>
                            {% if existing_links %}
                            <span class="badge bg-info ms-1">{{ existing_links.total_links }}</span>
                            {% endif %}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ai-suggestions-tab" data-bs-toggle="tab"
                                data-bs-target="#ai-suggestions" type="button" role="tab">
                            <i class="fas fa-robot me-1"></i> <span style="cursor:help;" data-bs-toggle="tooltip" data-bs-trigger="hover" title="AI-generated product recommendations by Claude based on video content, audience, and real performance data when available.">AI Suggestions</span>
                            {% if affiliate_recs %}
                            <span class="badge bg-warning text-dark ms-1">{{ affiliate_recs|length }}</span>
                            {% endif %}
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content pt-3" id="affiliateTabContent">

                    <!-- Tab 1: Real Performance (from BigQuery) -->
                    <div class="tab-pane fade show active" id="real-performance" role="tabpanel">
                        {% if affiliate_performance %}
                            {% set total_rev = affiliate_performance | map(attribute='total_revenue') | sum %}
                            {% set total_clicks = affiliate_performance | map(attribute='total_clicks') | sum %}
                            {% set total_sales = affiliate_performance | map(attribute='total_sales') | sum %}
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="border rounded p-2 text-center">
                                        <small class="text-muted d-block" style="cursor:help;" data-bs-toggle="tooltip" title="Sum of all affiliate revenue for this video. Source: BigQuery Revenue_Metrics table.">Total Revenue</small>
                                        <strong class="text-success fs-5">${{ "%.2f" | format(total_rev) }}</strong>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-2 text-center">
                                        <small class="text-muted d-block" style="cursor:help;" data-bs-toggle="tooltip" title="Sum of all affiliate link clicks tracked for this video. Source: BigQuery Revenue_Metrics table.">Total Clicks</small>
                                        <strong class="fs-5">{{ total_clicks }}</strong>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-2 text-center">
                                        <small class="text-muted d-block" style="cursor:help;" data-bs-toggle="tooltip" title="Sum of all completed sales attributed to this video's affiliate links. Source: BigQuery Revenue_Metrics table.">Total Sales</small>
                                        <strong class="fs-5">{{ total_sales }}</strong>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-2 text-center">
                                        <small class="text-muted d-block" style="cursor:help;" data-bs-toggle="tooltip" title="Number of unique affiliate tracking IDs found for this video in BigQuery.">Tracking IDs</small>
                                        <strong class="fs-5">{{ affiliate_performance|length }}</strong>
                                    </div>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="cursor:help;" data-bs-toggle="tooltip" title="Unique affiliate tracking ID from BigQuery used to attribute clicks/sales to this video.">Tracking ID</th>
                                            <th>Affiliate</th>
                                            <th style="cursor:help;" data-bs-toggle="tooltip" title="Affiliate network or platform detected from URL patterns and known affiliate names.">Platform</th>
                                            <th style="cursor:help;" data-bs-toggle="tooltip" title="Where the affiliate link was placed (e.g., description, pinned comment).">Placement</th>
                                            <th class="text-end">Revenue</th>
                                            <th class="text-end">Clicks</th>
                                            <th class="text-end">Sales</th>
                                            <th class="text-end" style="cursor:help;" data-bs-toggle="tooltip" title="Conversion rate = (sales / clicks) × 100. From BigQuery.">Conv%</th>
                                            <th class="text-end" style="cursor:help;" data-bs-toggle="tooltip" title="Revenue per click = total revenue / total clicks. From BigQuery.">Rev/Click</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for perf in affiliate_performance %}
                                        <tr>
                                            <td><code class="small">{{ perf.tracking_id }}</code></td>
                                            <td>{{ perf.affiliate }}</td>
                                            <td><span class="badge bg-secondary">{{ perf.platform }}</span></td>
                                            <td>{{ perf.link_placement }}</td>
                                            <td class="text-end{% if perf.total_revenue > 0 %} text-success fw-bold{% endif %}">
                                                ${{ "%.2f" | format(perf.total_revenue) }}
                                            </td>
                                            <td class="text-end">{{ perf.total_clicks }}</td>
                                            <td class="text-end">{{ perf.total_sales }}</td>
                                            <td class="text-end">{{ "%.1f" | format(perf.conversion_rate) }}%</td>
                                            <td class="text-end">${{ "%.2f" | format(perf.revenue_per_click) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <small class="text-muted"><i class="fas fa-database me-1"></i>Source: BigQuery Revenue_Metrics (all-time aggregated by tracking ID)</small>
                        {% else %}
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i> No affiliate tracking data found for this video in BigQuery.
                            </div>
                        {% endif %}
                    </div>

                    <!-- Tab 2: Existing Links (from description parsing) -->
                    <div class="tab-pane fade" id="existing-links" role="tabpanel">
                        {% if existing_links %}
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="border rounded p-2 text-center">
                                        <small class="text-muted d-block" style="cursor:help;" data-bs-toggle="tooltip" title="All URLs found in the video description using regex pattern matching.">Total Links</small>
                                        <strong class="fs-5">{{ existing_links.total_links }}</strong>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-2 text-center">
                                        <small class="text-muted d-block" style="cursor:help;" data-bs-toggle="tooltip" title="Links detected as affiliate using URL shortener patterns, tracking params, known affiliate networks, and BigQuery affiliate names.">Affiliate Links</small>
                                        <strong class="text-success fs-5">{{ existing_links.affiliate_links }}</strong>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-2 text-center">
                                        <small class="text-muted d-block" style="cursor:help;" data-bs-toggle="tooltip" title="Links not matching any known affiliate patterns (social links, YouTube links, etc.).">Non-Affiliate</small>
                                        <strong class="fs-5">{{ existing_links.non_affiliate_links }}</strong>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-2 text-center">
                                        <small class="text-muted d-block" style="cursor:help;" data-bs-toggle="tooltip" title="Checks if description contains affiliate disclosure keywords (affiliate, commission, sponsored, etc.).">Disclosure</small>
                                        {% if existing_links.has_affiliate_disclosure %}
                                            <strong class="text-success fs-5"><i class="fas fa-check-circle"></i> Yes</strong>
                                        {% else %}
                                            <strong class="text-danger fs-5"><i class="fas fa-times-circle"></i> No</strong>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            {% if existing_links.links %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>URL</th>
                                            <th style="cursor:help;" data-bs-toggle="tooltip" title="Detected from URL domain, known affiliate names from BigQuery, or extracted from URL shortener paths.">Platform</th>
                                            <th style="cursor:help;" data-bs-toggle="tooltip" title="Detected using: URL shorteners (bit.ly, etc.), tracking params (?tag=, /ref=), affiliate networks (ShareASale, Impact, etc.), deal subdomains, and known affiliate names.">Affiliate?</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for link in existing_links.links %}
                                        <tr>
                                            <td>{{ loop.index }}</td>
                                            <td>
                                                <a href="{{ link.url }}" target="_blank" rel="noopener" class="small text-truncate d-inline-block" style="max-width: 500px;">
                                                    {{ link.url }}
                                                </a>
                                            </td>
                                            <td><span class="badge bg-secondary">{{ link.platform }}</span></td>
                                            <td>
                                                {% if link.is_affiliate %}
                                                    <span class="badge bg-success">Affiliate</span>
                                                {% else %}
                                                    <span class="badge bg-light text-dark">No</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}
                            <small class="text-muted"><i class="fas fa-search me-1"></i>Parsed from video description using pattern matching</small>
                        {% else %}
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i> No description available to parse links from.
                            </div>
                        {% endif %}
                    </div>

                    <!-- Tab 3: AI Suggestions -->
                    <div class="tab-pane fade" id="ai-suggestions" role="tabpanel">
                        {% if affiliate_recs %}
                            <div class="alert alert-light border mb-3 py-2">
                                <small><i class="fas fa-robot me-1"></i> These recommendations are <strong>AI-generated estimates</strong> by Claude AI based on video transcript, title, description, and real BigQuery performance data when available. Cross-reference with the BigQuery Data tab for actual data.</small>
                            </div>
                            <div class="list-group list-group-flush">
                                {% for rec in affiliate_recs[:5] %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                {{ rec.product_rank }}. {{ rec.product_name }}
                                                {% if rec.mentioned_in_video %}
                                                    <span class="badge bg-info ms-1">Mentioned in video</span>
                                                {% endif %}
                                            </h6>
                                            <p class="mb-1 small">{{ rec.recommendation_reasoning }}</p>
                                            <div class="small text-muted">
                                                <span class="me-3"><i class="fas fa-folder me-1"></i>{{ rec.product_category }}</span>
                                                {% if rec.where_to_mention %}
                                                <span class="me-3"><i class="fas fa-map-pin me-1"></i>{{ rec.where_to_mention }}</span>
                                                {% endif %}
                                                {% if rec.price_range %}
                                                <span><i class="fas fa-tag me-1"></i>{{ rec.price_range }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="text-end ms-3">
                                            <span class="badge bg-success" data-bs-toggle="tooltip" title="AI relevance score (Claude): how closely this product matches the video's exact topic. 90-100% = same product, 70-89% = direct competitor.">
                                                {{ "%.0f" | format(rec.relevance_score * 100) }}% relevance
                                            </span>
                                            <br>
                                            <small class="text-muted" data-bs-toggle="tooltip" title="Estimated conversion rate. Based on real BigQuery data when available, otherwise AI-estimated by Claude.">
                                                {{ "%.0f" | format(rec.conversion_probability * 100) }}% est. conversion
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i> No AI recommendations available. Click "Re-analyze" with Affiliate enabled.
                            </div>
                        {% endif %}
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Generic Detail Modal (used by all section expand buttons) -->
<style>
    /* Expanded layout inside detail modal */
    #detailModalBody .col-md-4 { flex: 0 0 50%; max-width: 50%; }
    #detailModalBody .col-md-6 { flex: 0 0 50%; max-width: 50%; }
    #detailModalBody .card { border: 1px solid #dee2e6; }
    #detailModalBody .card-body { padding: 1rem; }
    #detailModalBody .progress { height: 30px; }
    #detailModalBody p, #detailModalBody li { font-size: 0.95rem; }
    #detailModalBody .table { font-size: 0.9rem; }
    #detailModalBody pre { max-height: none; }
</style>
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" id="detailModalHeader">
                <h5 class="modal-title" id="detailModalTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4" id="detailModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Fixed Status Bar for Transcription Progress -->
<div id="transcriptionStatusBar" class="fixed-bottom bg-dark text-white py-2 px-3 shadow-lg" style="display: none; z-index: 1050; transition: bottom 0.3s ease;">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-auto">
                <span class="spinner-border spinner-border-sm text-success me-2" id="statusSpinner"></span>
                <i class="fas fa-check-circle text-success me-2" id="statusCheck" style="display: none;"></i>
                <i class="fas fa-times-circle text-danger me-2" id="statusError" style="display: none;"></i>
            </div>
            <div class="col">
                <div class="d-flex align-items-center">
                    <span id="statusText" class="me-3">Processing...</span>
                    <div class="progress flex-grow-1" style="height: 8px; max-width: 300px;">
                        <div class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                             id="statusProgressBar" style="width: 0%"></div>
                    </div>
                    <span class="ms-2 small" id="statusPercent">0%</span>
                </div>
                <div class="small text-muted mt-1" id="statusSteps">
                    <span id="statusStep-download" class="me-2"><i class="fas fa-circle text-secondary"></i> Download</span>
                    <span id="statusStep-frames" class="me-2" style="display: none;"><i class="fas fa-circle text-secondary"></i> Frames</span>
                    <span id="statusStep-transcribe" class="me-2"><i class="fas fa-circle text-secondary"></i> Transcribe</span>
                    <span id="statusStep-emotions" class="me-2" style="display: none;"><i class="fas fa-circle text-secondary"></i> Emotions</span>
                    <span id="statusStep-insights" class="me-2" style="display: none;"><i class="fas fa-circle text-secondary"></i> Insights</span>
                    <span id="statusStep-save" class="me-2"><i class="fas fa-circle text-secondary"></i> Save</span>
                </div>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-sm btn-outline-light" id="statusCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Fixed Status Bar for Analysis Progress -->
<div id="analysisStatusBar" class="fixed-bottom bg-primary text-white py-2 px-3 shadow-lg" style="display: none; z-index: 1051;">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-auto">
                <span class="spinner-border spinner-border-sm text-light me-2" id="analysisSpinner"></span>
                <i class="fas fa-check-circle text-light me-2" id="analysisCheck" style="display: none;"></i>
                <i class="fas fa-times-circle text-warning me-2" id="analysisErrorIcon" style="display: none;"></i>
            </div>
            <div class="col">
                <div class="d-flex align-items-center">
                    <span id="analysisStatusText" class="me-3">Analyzing...</span>
                    <div class="progress flex-grow-1 bg-white bg-opacity-25" style="height: 8px; max-width: 300px;">
                        <div class="progress-bar bg-light progress-bar-striped progress-bar-animated"
                             id="analysisProgressBar" style="width: 0%"></div>
                    </div>
                    <span class="ms-2 small" id="analysisPercent">0%</span>
                </div>
                <div class="small text-white-50 mt-1" id="analysisSteps">
                    <span id="analysisStep-script" class="me-2"><i class="fas fa-circle"></i> Script</span>
                    <span id="analysisStep-description" class="me-2"><i class="fas fa-circle"></i> Description</span>
                    <span id="analysisStep-affiliate" class="me-2"><i class="fas fa-circle"></i> Affiliates</span>
                    <span id="analysisStep-conversion" class="me-2"><i class="fas fa-circle"></i> Conversion</span>
                    <span id="analysisStep-script_score" class="me-2"><i class="fas fa-circle"></i> Score</span>
                </div>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-sm btn-outline-light" id="analysisCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Re-Analyze Confirmation Modal -->
<div class="modal fade" id="reanalyzeModal" tabindex="-1" aria-labelledby="reanalyzeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="reanalyzeModalLabel">
                    <i class="fas fa-brain me-2"></i>{% if script_analysis or description_analysis or affiliate_recs or conversion_analysis %}Re-Analyze Video{% else %}Analyze Video{% endif %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if script_analysis or description_analysis or affiliate_recs or conversion_analysis %}
                <div class="alert alert-secondary mb-3 py-2">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Existing data:</strong>
                    {% if script_analysis %}<span class="badge bg-success ms-1">Script</span>{% endif %}
                    {% if description_analysis %}<span class="badge bg-info ms-1">Description</span>{% endif %}
                    {% if affiliate_recs %}<span class="badge bg-warning text-dark ms-1">Affiliate</span>{% endif %}
                    {% if conversion_analysis %}<span class="badge bg-primary ms-1">Conversion</span>{% endif %}
                    {% if script_score %}<span class="badge bg-dark ms-1">Script Score</span>{% endif %}
                </div>
                {% endif %}

                <p class="text-muted mb-3">Select which analysis types to run (at least 1 required):</p>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input analysis-checkbox" type="checkbox" id="enableScript" {% if not script_analysis %}checked{% endif %}>
                        <label class="form-check-label" for="enableScript">
                            <i class="fas fa-file-alt text-success me-1"></i> Script Quality Analysis
                            {% if script_analysis %}
                            <span class="badge bg-secondary ms-1">exists</span>
                            {% endif %}
                        </label>
                    </div>
                    <small class="text-muted ms-4">Hook effectiveness, pacing, persuasion techniques, strengths & improvements</small>
                </div>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input analysis-checkbox" type="checkbox" id="enableDescription" {% if not description_analysis %}checked{% endif %}>
                        <label class="form-check-label" for="enableDescription">
                            <i class="fas fa-align-left text-info me-1"></i> Description CTR Analysis
                            {% if description_analysis %}
                            <span class="badge bg-secondary ms-1">exists</span>
                            {% endif %}
                        </label>
                    </div>
                    <small class="text-muted ms-4">Quality score, SEO score, CTA effectiveness, traffic sources & optimization tips</small>
                </div>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input analysis-checkbox" type="checkbox" id="enableAffiliate" {% if not affiliate_recs %}checked{% endif %}>
                        <label class="form-check-label" for="enableAffiliate">
                            <i class="fas fa-shopping-cart text-warning me-1"></i> Affiliate Performance → AI Suggestions
                            {% if affiliate_recs %}
                            <span class="badge bg-secondary ms-1">exists</span>
                            {% endif %}
                        </label>
                    </div>
                    <small class="text-muted ms-4">AI-generated product recommendations based on video content & real performance data</small>
                </div>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input analysis-checkbox" type="checkbox" id="enableConversion" {% if not conversion_analysis %}checked{% endif %}>
                        <label class="form-check-label" for="enableConversion">
                            <i class="fas fa-chart-line text-primary me-1"></i> Conversion Analysis
                            {% if conversion_analysis %}
                            <span class="badge bg-secondary ms-1">exists</span>
                            {% endif %}
                        </label>
                    </div>
                    <small class="text-muted ms-4">Conversion drivers, underperformance reasons & optimization recommendations</small>
                </div>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input analysis-checkbox" type="checkbox" id="enableScriptScore" {% if not script_score %}checked{% endif %}>
                        <label class="form-check-label" for="enableScriptScore">
                            <i class="fas fa-clipboard-check text-dark me-1"></i> Script Score (Gates + Quality)
                            {% if script_score %}
                            <span class="badge bg-secondary ms-1">exists</span>
                            {% endif %}
                        </label>
                    </div>
                    <small class="text-muted ms-4">6 gate checks, 6-dimension quality score (100pts), context multiplier, top 3 action items</small>
                </div>

                <div class="text-center mt-3">
                    <div class="p-2 bg-info bg-opacity-10 rounded d-inline-block">
                        <i class="fas fa-clock text-info me-2"></i>
                        <span class="small text-muted">Estimated Time:</span>
                        <strong>2-3 minutes</strong>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmReanalyzeBtn">
                    <i class="fas fa-play me-1"></i>Start Analysis
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transcribe & Analyze Modal -->
<div class="modal fade" id="transcribeModal" tabindex="-1" aria-labelledby="transcribeModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="transcribeModalLabel">
                    <i class="fas fa-microphone me-2"></i>Transcribe & Analyze Video
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" id="modalCloseBtn"></button>
            </div>
            <div class="modal-body">
                <!-- Configuration Form (shown initially) -->
                <div id="configSection">
                    {% if transcript_data %}
                    <div class="alert alert-secondary mb-3 py-2">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Existing data:</strong>
                        {% if transcript_data.transcript %}<span class="badge bg-success ms-1">Transcript</span>{% endif %}
                        {% if transcript_data.emotions %}<span class="badge bg-info ms-1">Emotions</span>{% endif %}
                        {% if transcript_data.frame_analysis %}<span class="badge bg-warning text-dark ms-1">Frames</span>{% endif %}
                        {% if transcript_data.content_insights %}<span class="badge bg-primary ms-1">Insights</span>{% endif %}
                    </div>
                    {% endif %}

                    <p class="text-muted mb-3">Select which data to generate (at least 1 required):</p>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableTranscript" {% if not transcript_data or not transcript_data.transcript %}checked{% endif %}>
                            <label class="form-check-label" for="enableTranscript">
                                <i class="fas fa-file-alt text-success me-1"></i> Generate Transcript
                                {% if transcript_data and transcript_data.transcript %}
                                <span class="badge bg-secondary ms-1">exists</span>
                                {% endif %}
                            </label>
                        </div>
                        <small class="text-muted ms-4">Download video and transcribe audio (Groq Whisper)</small>
                    </div>

                    <div id="transcriptOptions" class="ms-4 mb-3" style="display: none;">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="storeSegments" checked>
                            <label class="form-check-label small" for="storeSegments">
                                <i class="fas fa-clock text-secondary me-1"></i> Store segments with timestamps
                            </label>
                        </div>
                        <small class="text-muted ms-4">Enables viewing transcript with timestamps</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableEmotions">
                            <label class="form-check-label" for="enableEmotions">
                                <i class="fas fa-smile text-info me-1"></i> Voice Emotion Analysis (Hume AI)
                                {% if transcript_data and transcript_data.emotions %}
                                <span class="badge bg-secondary ms-1">exists</span>
                                {% endif %}
                            </label>
                        </div>
                        <small class="text-muted ms-4">Analyze voice prosody to detect emotions in speech</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableFrames">
                            <label class="form-check-label" for="enableFrames">
                                <i class="fas fa-images text-warning me-1"></i> Frame Analysis (Vision AI)
                                {% if transcript_data and transcript_data.frame_analysis %}
                                <span class="badge bg-secondary ms-1">exists</span>
                                {% endif %}
                            </label>
                        </div>
                        <small class="text-muted ms-4">Extract and analyze video frames with AI vision</small>
                    </div>

                    <div id="frameOptions" class="ms-4 mb-3" style="display: none;">
                        <label for="frameInterval" class="form-label">Frame Interval (seconds)</label>
                        <input type="number" class="form-control" id="frameInterval" value="10" min="1" max="300" step="1">
                        <div class="invalid-feedback" id="frameIntervalError">Please enter a value between 1 and 300 seconds.</div>
                        <small class="text-muted">Lower intervals = more frames = longer processing time (1-300 seconds)</small>
                    </div>

                    <hr class="my-3">

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableInsights" {% if not transcript_data or not transcript_data.content_insights %}checked{% endif %}>
                            <label class="form-check-label" for="enableInsights">
                                <i class="fas fa-lightbulb text-primary me-1"></i> Generate AI Content Insights
                                {% if transcript_data and transcript_data.content_insights %}
                                <span class="badge bg-secondary ms-1">exists</span>
                                {% endif %}
                            </label>
                        </div>
                        <small class="text-muted ms-4">Combine transcript + emotions + frames for comprehensive analysis</small>
                        <div class="small text-info ms-4 mt-1" id="insightsDataSource">
                            <i class="fas fa-info-circle me-1"></i> Will use: <span id="insightsSourceList">new transcript</span>
                        </div>
                    </div>

                    <div class="alert alert-info small">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Estimated time:</strong>
                        <span id="estimatedTime">2-3 minutes</span>
                    </div>
                </div>

                <!-- Progress Section (shown during processing) -->
                <div id="progressSection" style="display: none;">
                    <div class="text-center mb-3">
                        <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                    </div>

                    <h6 class="text-center mb-3" id="progressTitle">Starting...</h6>

                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                             role="progressbar" id="progressBar" style="width: 0%">0%</div>
                    </div>

                    <div id="progressSteps" class="small">
                        <div class="d-flex align-items-center mb-2" id="step-download">
                            <i class="fas fa-circle text-secondary me-2" id="icon-download"></i>
                            <span>Downloading video/audio...</span>
                        </div>
                        <div class="d-flex align-items-center mb-2" id="step-frames" style="display: none;">
                            <i class="fas fa-circle text-secondary me-2" id="icon-frames"></i>
                            <span>Extracting and analyzing frames...</span>
                        </div>
                        <div class="d-flex align-items-center mb-2" id="step-transcribe">
                            <i class="fas fa-circle text-secondary me-2" id="icon-transcribe"></i>
                            <span>Transcribing audio (Groq Whisper)...</span>
                        </div>
                        <div class="d-flex align-items-center mb-2" id="step-emotions" style="display: none;">
                            <i class="fas fa-circle text-secondary me-2" id="icon-emotions"></i>
                            <span>Analyzing voice emotions (Hume AI)...</span>
                        </div>
                        <div class="d-flex align-items-center mb-2" id="step-save">
                            <i class="fas fa-circle text-secondary me-2" id="icon-save"></i>
                            <span>Saving results...</span>
                        </div>
                    </div>

                    <div class="alert alert-warning small mt-3">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Please don't close this window while processing.
                    </div>
                </div>

                <!-- Completion Section (shown when done) -->
                <div id="completionSection" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                        <h5 class="mt-3">Analysis Complete!</h5>
                        <p class="text-muted">The page will refresh to show the results.</p>
                    </div>
                </div>

                <!-- Error Section -->
                <div id="errorSection" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>
                        <h5 class="mt-3">Analysis Failed</h5>
                        <p class="text-muted" id="errorMessage">An error occurred during processing.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="modalFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelBtn">Cancel</button>
                <button type="button" class="btn btn-success" id="startAnalysisBtn">
                    <i class="fas fa-play me-1"></i> Start
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Generic detail modal - clones card content into a fullscreen modal
function openDetailModal(cardId, title, bgClass, iconClass, modalSize) {
    var card = document.getElementById(cardId);
    if (!card) return;
    var cardBody = card.querySelector('.card-body');
    if (!cardBody) return;

    var modal = document.getElementById('detailModal');
    var modalDialog = modal.querySelector('.modal-dialog');
    var modalHeader = document.getElementById('detailModalHeader');
    var modalBody = document.getElementById('detailModalBody');
    var modalTitle = document.getElementById('detailModalTitle');

    // Set modal size (default fullscreen)
    modalDialog.className = 'modal-dialog ' + (modalSize || 'modal-fullscreen') + ' modal-dialog-scrollable';

    // Set header styling
    modalHeader.className = 'modal-header text-white ' + (bgClass || 'bg-secondary');
    // For bg-warning which has dark text
    if (bgClass && bgClass.indexOf('text-dark') !== -1) {
        modalHeader.classList.remove('text-white');
    }
    // For emotion card (custom purple)
    if (!bgClass) {
        modalHeader.style.backgroundColor = '#6f42c1';
        modalHeader.classList.add('text-white');
    } else {
        modalHeader.style.backgroundColor = '';
    }
    modalTitle.innerHTML = '<i class="' + iconClass + ' me-2"></i>' + title;

    // Clone card body
    var clone = cardBody.cloneNode(true);

    // Prefix all IDs to avoid duplicates
    var idMap = {};
    clone.querySelectorAll('[id]').forEach(function(el) {
        var oldId = el.id;
        var newId = 'modal-' + oldId;
        idMap[oldId] = newId;
        el.id = newId;
    });

    // Fix data-bs-target references
    clone.querySelectorAll('[data-bs-target]').forEach(function(el) {
        var target = el.getAttribute('data-bs-target');
        if (target && target.charAt(0) === '#') {
            var oldId = target.substring(1);
            if (idMap[oldId]) {
                el.setAttribute('data-bs-target', '#' + idMap[oldId]);
            }
        }
    });

    // Fix aria-labelledby and aria-controls
    clone.querySelectorAll('[aria-labelledby]').forEach(function(el) {
        var oldId = el.getAttribute('aria-labelledby');
        if (idMap[oldId]) el.setAttribute('aria-labelledby', idMap[oldId]);
    });
    clone.querySelectorAll('[aria-controls]').forEach(function(el) {
        var oldId = el.getAttribute('aria-controls');
        if (idMap[oldId]) el.setAttribute('aria-controls', idMap[oldId]);
    });
    clone.querySelectorAll('[href]').forEach(function(el) {
        var href = el.getAttribute('href');
        if (href && href.charAt(0) === '#') {
            var oldId = href.substring(1);
            if (idMap[oldId]) el.setAttribute('href', '#' + idMap[oldId]);
        }
    });

    // Remove max-height and overflow restrictions for fullscreen view
    // Also clean the clone element itself (querySelectorAll only finds descendants)
    function removeScrollConstraints(el) {
        if (el.style.maxHeight) el.style.maxHeight = 'none';
        if (el.style.overflowY === 'auto' || el.style.overflowY === 'scroll') el.style.overflowY = '';
        if (el.style.overflow === 'auto' || el.style.overflow === 'scroll') el.style.overflow = '';
    }
    removeScrollConstraints(clone);
    clone.querySelectorAll('[style]').forEach(removeScrollConstraints);

    modalBody.innerHTML = '';
    modalBody.appendChild(clone);

    // Re-initialize Bootstrap tabs in cloned content
    clone.querySelectorAll('[data-bs-toggle="tab"]').forEach(function(tabEl) {
        new bootstrap.Tab(tabEl);
    });

    bootstrap.Modal.getOrCreateInstance(modal).show();
}

document.addEventListener('DOMContentLoaded', function() {
    const videoId = '{{ video.video_id }}';
    const hasExistingTranscript = {{ 'true' if transcript_data and transcript_data.transcript else 'false' }};
    const hasExistingEmotions = {{ 'true' if transcript_data and transcript_data.emotions else 'false' }};
    const hasExistingFrames = {{ 'true' if transcript_data and transcript_data.frame_analysis else 'false' }};

    // Elements
    const enableTranscript = document.getElementById('enableTranscript');
    const enableFrames = document.getElementById('enableFrames');
    const enableEmotions = document.getElementById('enableEmotions');
    const enableInsights = document.getElementById('enableInsights');
    const frameOptions = document.getElementById('frameOptions');
    const transcriptOptions = document.getElementById('transcriptOptions');
    const storeSegments = document.getElementById('storeSegments');
    const frameInterval = document.getElementById('frameInterval');
    const estimatedTime = document.getElementById('estimatedTime');
    const startBtn = document.getElementById('startAnalysisBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const insightsSourceList = document.getElementById('insightsSourceList');

    const configSection = document.getElementById('configSection');
    const progressSection = document.getElementById('progressSection');
    const completionSection = document.getElementById('completionSection');
    const errorSection = document.getElementById('errorSection');
    const modalFooter = document.getElementById('modalFooter');

    // Update insights data source display
    function updateInsightsSource() {
        if (!enableInsights || !enableInsights.checked) {
            document.getElementById('insightsDataSource').style.display = 'none';
            return;
        }
        document.getElementById('insightsDataSource').style.display = 'block';

        const sources = [];
        // Transcript
        if (enableTranscript && enableTranscript.checked) {
            sources.push('new transcript');
        } else if (hasExistingTranscript) {
            sources.push('existing transcript');
        }
        // Emotions
        if (enableEmotions && enableEmotions.checked) {
            sources.push('new emotions');
        } else if (hasExistingEmotions) {
            sources.push('existing emotions');
        }
        // Frames
        if (enableFrames && enableFrames.checked) {
            sources.push('new frames');
        } else if (hasExistingFrames) {
            sources.push('existing frames');
        }

        insightsSourceList.textContent = sources.length > 0 ? sources.join(' + ') : 'no data available';
    }

    // Validate at least one option is selected and data is available
    function validateSelection() {
        const transcriptSelected = enableTranscript && enableTranscript.checked;
        const emotionsSelected = enableEmotions && enableEmotions.checked;
        const framesSelected = enableFrames && enableFrames.checked;
        const insightsSelected = enableInsights && enableInsights.checked;

        const anySelected = transcriptSelected || emotionsSelected || framesSelected || insightsSelected;

        // Check if only insights is selected with no data available
        const onlyInsightsSelected = insightsSelected && !transcriptSelected && !emotionsSelected && !framesSelected;
        const noDataAvailable = insightsSourceList.textContent === 'no data available';

        // Disable if nothing selected OR if only insights selected with no data
        const shouldDisable = !anySelected || (onlyInsightsSelected && noDataAvailable);
        startBtn.disabled = shouldDisable;
        return !shouldDisable;  // Return true if selection is valid
    }

    // Show/hide frame options
    enableFrames.addEventListener('change', function() {
        frameOptions.style.display = this.checked ? 'block' : 'none';
        document.getElementById('step-frames').style.display = this.checked ? 'flex' : 'none';
        updateEstimatedTime();
        updateInsightsSource();
        validateSelection();
    });

    enableEmotions.addEventListener('change', function() {
        document.getElementById('step-emotions').style.display = this.checked ? 'flex' : 'none';
        updateEstimatedTime();
        updateInsightsSource();
        validateSelection();
    });

    enableTranscript.addEventListener('change', function() {
        document.getElementById('step-download').style.display = this.checked ? 'inline' : 'none';
        document.getElementById('step-transcribe').style.display = this.checked ? 'inline' : 'none';
        transcriptOptions.style.display = this.checked ? 'block' : 'none';
        updateEstimatedTime();
        updateInsightsSource();
        validateSelection();
    });

    enableInsights.addEventListener('change', function() {
        updateInsightsSource();
        validateSelection();
    });

    frameInterval.addEventListener('input', updateEstimatedTime);
    frameInterval.addEventListener('input', validateFrameInterval);

    // Initialize
    updateInsightsSource();
    validateSelection();
    updateEstimatedTime();
    // Initialize step visibility based on default checkbox states
    document.getElementById('step-download').style.display = enableTranscript.checked ? 'inline' : 'none';
    document.getElementById('step-transcribe').style.display = enableTranscript.checked ? 'inline' : 'none';
    transcriptOptions.style.display = enableTranscript.checked ? 'block' : 'none';

    function validateFrameInterval() {
        const value = parseInt(frameInterval.value);
        const isValid = !isNaN(value) && value >= 1 && value <= 300;

        if (isValid) {
            frameInterval.classList.remove('is-invalid');
            frameInterval.classList.add('is-valid');
        } else {
            frameInterval.classList.remove('is-valid');
            frameInterval.classList.add('is-invalid');
        }

        return isValid;
    }

    function updateEstimatedTime() {
        let time = 0;
        let features = [];

        if (enableTranscript && enableTranscript.checked) {
            time += 2; // Base transcription time
            features.push('transcript');
        }
        if (enableEmotions && enableEmotions.checked) {
            time += 1;
            features.push('emotions');
        }
        if (enableFrames && enableFrames.checked) {
            const interval = parseInt(frameInterval.value) || 10;
            if (interval <= 5) time += 5;
            else if (interval <= 10) time += 3;
            else if (interval <= 30) time += 2;
            else time += 1;
            features.push('frames');
        }
        if (enableInsights && enableInsights.checked) {
            time += 0.5; // Insights generation is quick
            features.push('insights');
        }

        if (features.length === 0) {
            estimatedTime.textContent = 'Select at least one option';
        } else {
            estimatedTime.textContent = `${Math.max(1, time)}-${time+2} minutes (${features.join(' + ')})`;
        }
    }

    // Delete existing transcript
    const deleteBtn = document.getElementById('deleteTranscriptBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            if (!confirm('Are you sure you want to delete the existing transcript? This cannot be undone.')) {
                return;
            }

            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Deleting...';

            fetch(`/api/v1/transcript/${videoId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'deleted') {
                    location.reload();
                } else {
                    alert('Failed to delete transcript: ' + (data.error || 'Unknown error'));
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-trash me-1"></i> Delete & Re-transcribe';
                }
            })
            .catch(err => {
                alert('Error: ' + err.message);
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-trash me-1"></i> Delete & Re-transcribe';
            });
        });
    }

    // Navbar badge elements
    const navTaskNotif = document.getElementById('navTaskNotif');
    const navTaskBadge = document.getElementById('navTaskBadge');
    const navTaskIconSpin = document.getElementById('navTaskIconSpin');
    const navTaskIconDone = document.getElementById('navTaskIconDone');
    const navTaskIconError = document.getElementById('navTaskIconError');

    function updateNavBadge() {
        const tVisible = statusBar && statusBar.style.display !== 'none';
        const aVisible = analysisStatusBar && analysisStatusBar.style.display !== 'none';
        const count = (tVisible ? 1 : 0) + (aVisible ? 1 : 0);
        if (navTaskNotif) {
            navTaskNotif.style.display = count > 0 ? 'block' : 'none';
            navTaskBadge.textContent = count;
            navTaskIconSpin.style.display = count > 0 ? 'inline-block' : 'none';
            navTaskIconDone.style.display = 'none';
            navTaskIconError.style.display = 'none';
        }
    }

    function showNavBadgeComplete() {
        if (navTaskNotif) {
            navTaskIconSpin.style.display = 'none';
            navTaskIconDone.style.display = 'inline-block';
            navTaskIconError.style.display = 'none';
            setTimeout(() => {
                const tVisible = statusBar && statusBar.style.display !== 'none';
                const aVisible = analysisStatusBar && analysisStatusBar.style.display !== 'none';
                if (!tVisible && !aVisible) navTaskNotif.style.display = 'none';
            }, 3000);
        }
    }

    function showNavBadgeError() {
        if (navTaskNotif) {
            navTaskNotif.style.display = 'block';
            navTaskIconSpin.style.display = 'none';
            navTaskIconDone.style.display = 'none';
            navTaskIconError.style.display = 'inline-block';
        }
    }

    // Status bar elements
    const statusBar = document.getElementById('transcriptionStatusBar');
    const statusSpinner = document.getElementById('statusSpinner');
    const statusCheck = document.getElementById('statusCheck');
    const statusErrorIcon = document.getElementById('statusError');
    const statusText = document.getElementById('statusText');
    const statusProgressBar = document.getElementById('statusProgressBar');
    const statusPercent = document.getElementById('statusPercent');
    const statusCloseBtn = document.getElementById('statusCloseBtn');

    // Close status bar button
    statusCloseBtn.addEventListener('click', function() {
        statusBar.style.display = 'none';
        updateStatusBarPositions();
        updateNavBadge();
    });

    // Function to stack status bars when both are visible
    function updateStatusBarPositions() {
        const transcriptionVisible = statusBar.style.display !== 'none';
        const analysisVisible = analysisStatusBar.style.display !== 'none';

        if (transcriptionVisible && analysisVisible) {
            // Stack transcription bar above analysis bar
            statusBar.style.bottom = '60px';
        } else {
            statusBar.style.bottom = '0';
        }
    }

    // Start analysis
    startBtn.addEventListener('click', function() {
        // Validate at least one option
        if (!validateSelection()) {
            alert('Please select at least one option.');
            return;
        }

        // Validate frame interval if frames are enabled
        if (enableFrames.checked && !validateFrameInterval()) {
            frameInterval.focus();
            return;
        }

        const withTranscript = enableTranscript && enableTranscript.checked;
        const withEmotions = enableEmotions && enableEmotions.checked;
        const withFrames = enableFrames && enableFrames.checked;
        const withInsights = enableInsights && enableInsights.checked;

        // Close modal and show status bar
        const modal = bootstrap.Modal.getInstance(document.getElementById('transcribeModal'));
        modal.hide();

        // Show status bar with correct steps
        statusBar.style.display = 'block';
        statusSpinner.style.display = 'inline-block';
        statusCheck.style.display = 'none';
        statusErrorIcon.style.display = 'none';
        // statusCloseBtn always visible
        statusText.textContent = 'Starting...';
        statusProgressBar.style.width = '0%';
        statusPercent.textContent = '0%';
        updateStatusBarPositions();

        updateNavBadge();

        // Show/hide relevant steps in status bar
        const needsDownload = withTranscript || withEmotions || withFrames;
        document.getElementById('statusStep-download').style.display = needsDownload ? 'inline' : 'none';
        document.getElementById('statusStep-transcribe').style.display = withTranscript ? 'inline' : 'none';
        document.getElementById('statusStep-frames').style.display = withFrames ? 'inline' : 'none';
        document.getElementById('statusStep-emotions').style.display = withEmotions ? 'inline' : 'none';
        document.getElementById('statusStep-insights').style.display = withInsights ? 'inline' : 'none';

        // Disable the transcribe button
        document.querySelector('[data-bs-target="#transcribeModal"]').disabled = true;

        // Prepare options
        const options = {
            video_id: videoId,
            generate_transcript: withTranscript,
            analyze_emotions: withEmotions,
            analyze_frames: withFrames,
            generate_insights: withInsights
        };

        if (withTranscript && storeSegments && storeSegments.checked) {
            options.store_segments = true;
        }

        if (withFrames) {
            options.frame_interval = parseInt(frameInterval.value) || 10;
        }

        // Start the transcription
        fetch('/api/v1/transcribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(options)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || `HTTP ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'started') {
                // Start polling for progress
                pollStatusBar(withTranscript, withEmotions, withFrames, withInsights);
            } else if (data.status === 'completed') {
                // Insights-only completed immediately
                showStatusCompletion('Complete! Refreshing page...');
                setTimeout(() => location.reload(), 1500);
            } else if (data.status === 'exists') {
                showStatusCompletion('Transcript already exists! Refreshing...');
                setTimeout(() => location.reload(), 1500);
            } else {
                showStatusError(data.error || 'Unknown error');
            }
        })
        .catch(err => {
            showStatusError(err.message || 'Failed to start analysis');
        });
    });

    function pollStatusBar(withTranscript, withEmotions, withFrames, withInsights) {
        const checkStatus = () => {
            fetch(`/api/v1/transcribe/status/${videoId}`)
            .then(response => response.json())
            .then(data => {
                updateStatusBar(data, withTranscript, withEmotions, withFrames, withInsights);

                if (data.status === 'completed') {
                    showStatusCompletion('Complete! Refreshing page...');
                    setTimeout(() => location.reload(), 1500);
                } else if (data.status === 'error') {
                    showStatusError(data.error || 'Analysis failed');
                } else if (data.status === 'processing' || data.status === 'started') {
                    // Continue polling
                    setTimeout(checkStatus, 2000);
                } else {
                    // Not found or done - check if transcript exists
                    fetch(`/api/v1/transcript/${videoId}`)
                    .then(r => r.json())
                    .then(t => {
                        if (t.exists) {
                            showStatusCompletion('Complete! Refreshing page...');
                            setTimeout(() => location.reload(), 1500);
                        } else if (t.is_transcribing) {
                            setTimeout(checkStatus, 2000);
                        } else {
                            showStatusError('Processing stopped unexpectedly');
                        }
                    });
                }
            })
            .catch(() => {
                // On error, wait and retry
                setTimeout(checkStatus, 3000);
            });
        };

        setTimeout(checkStatus, 2000);
    }

    function updateStatusBar(data, withTranscript, withEmotions, withFrames, withInsights) {
        const step = data.step || 'download';
        const progress = data.progress || 0;
        const message = data.message || 'Processing...';

        // Update progress bar and text
        statusProgressBar.style.width = progress + '%';
        statusPercent.textContent = progress + '%';
        statusText.textContent = message;

        // Build step list based on enabled options
        const steps = [];
        const needsDownload = withTranscript || withEmotions || withFrames;
        if (needsDownload) steps.push('download');
        if (withFrames) steps.push('frames');
        if (withTranscript) steps.push('transcribe');
        if (withEmotions) steps.push('emotions');
        if (withInsights) steps.push('insights');
        steps.push('save');

        const currentIdx = steps.indexOf(step);
        steps.forEach((s, idx) => {
            const stepEl = document.getElementById('statusStep-' + s);
            if (stepEl) {
                const icon = stepEl.querySelector('i');
                if (idx < currentIdx) {
                    icon.className = 'fas fa-check-circle text-success';
                } else if (idx === currentIdx) {
                    icon.className = 'fas fa-spinner fa-spin text-info';
                } else {
                    icon.className = 'fas fa-circle text-secondary';
                }
            }
        });
    }

    function showStatusCompletion(message) {
        statusSpinner.style.display = 'none';
        statusCheck.style.display = 'inline-block';
        statusErrorIcon.style.display = 'none';
        statusText.textContent = message || 'Complete!';
        statusProgressBar.style.width = '100%';
        statusPercent.textContent = '100%';
        statusProgressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
        ['download', 'frames', 'transcribe', 'emotions', 'insights', 'save'].forEach(s => {
            const stepEl = document.getElementById('statusStep-' + s);
            if (stepEl && stepEl.style.display !== 'none') {
                stepEl.querySelector('i').className = 'fas fa-check-circle text-success';
            }
        });
        showNavBadgeComplete();
    }

    function showStatusError(message) {
        statusSpinner.style.display = 'none';
        statusCheck.style.display = 'none';
        statusErrorIcon.style.display = 'inline-block';
        statusText.textContent = message || 'Error occurred';
        document.querySelector('[data-bs-target="#transcribeModal"]').disabled = false;
        showNavBadgeError();
    }

    // ==================== RE-ANALYZE BUTTON ====================
    const reanalyzeBtn = document.getElementById('reanalyzeBtn');
    const analysisStatusBar = document.getElementById('analysisStatusBar');
    const analysisSpinner = document.getElementById('analysisSpinner');
    const analysisCheck = document.getElementById('analysisCheck');
    const analysisErrorIcon = document.getElementById('analysisErrorIcon');
    const analysisStatusText = document.getElementById('analysisStatusText');
    const analysisProgressBar = document.getElementById('analysisProgressBar');
    const analysisPercent = document.getElementById('analysisPercent');
    const analysisCloseBtn = document.getElementById('analysisCloseBtn');

    // Close analysis status bar
    analysisCloseBtn.addEventListener('click', function() {
        analysisStatusBar.style.display = 'none';
        updateStatusBarPositions();
        updateNavBadge();
    });

    // Re-analyze modal confirm button click
    const confirmReanalyzeBtn = document.getElementById('confirmReanalyzeBtn');
    confirmReanalyzeBtn.addEventListener('click', function() {
        // Get selected analysis types from checkboxes
        const analysisTypes = [];
        if (document.getElementById('enableScript').checked) analysisTypes.push('script');
        if (document.getElementById('enableDescription').checked) analysisTypes.push('description');
        if (document.getElementById('enableAffiliate').checked) analysisTypes.push('affiliate');
        if (document.getElementById('enableConversion').checked) analysisTypes.push('conversion');
        if (document.getElementById('enableScriptScore').checked) analysisTypes.push('script_score');

        // Validate at least one selected
        if (analysisTypes.length === 0) {
            alert('Please select at least one analysis type.');
            return;
        }

        // Close the modal
        const reanalyzeModal = bootstrap.Modal.getInstance(document.getElementById('reanalyzeModal'));
        reanalyzeModal.hide();

        // Disable the re-analyze button
        reanalyzeBtn.disabled = true;

        // Show analysis status bar
        analysisStatusBar.style.display = 'block';
        analysisSpinner.style.display = 'inline-block';
        analysisCheck.style.display = 'none';
        analysisErrorIcon.style.display = 'none';
        // analysisCloseBtn always visible
        analysisStatusText.textContent = 'Starting analysis...';
        analysisProgressBar.style.width = '0%';
        analysisPercent.textContent = '0%';
        updateStatusBarPositions();
        updateNavBadge();

        // Reset step icons - show only selected types
        ['script', 'description', 'affiliate', 'conversion', 'script_score'].forEach(s => {
            const stepEl = document.getElementById('analysisStep-' + s);
            if (stepEl) {
                if (analysisTypes.includes(s)) {
                    stepEl.style.display = 'inline';
                    stepEl.querySelector('i').className = 'fas fa-circle';
                } else {
                    stepEl.style.display = 'none';
                }
            }
        });

        // Disable button
        reanalyzeBtn.disabled = true;

        // Start analysis with selected types
        fetch('/api/v1/analysis/trigger', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                video_id: videoId,
                analysis_types: analysisTypes
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'started' || data.status === 'already_running') {
                pollAnalysisStatus();
            } else if (data.error) {
                showAnalysisError(data.error);
            } else {
                showAnalysisError('Unknown error');
            }
        })
        .catch(err => {
            showAnalysisError(err.message || 'Failed to start analysis');
        });
    });

    function pollAnalysisStatus() {
        const checkStatus = () => {
            fetch(`/api/v1/analysis/status/${videoId}`)
            .then(response => response.json())
            .then(data => {
                updateAnalysisStatusBar(data);

                if (data.status === 'error') {
                    showAnalysisError(data.error || 'Analysis failed');
                } else if (data.status === 'not_running') {
                    // Analysis finished - refresh page
                    showAnalysisCompletion('Complete! Refreshing page...');
                    setTimeout(() => location.reload(), 1500);
                } else if (data.status === 'processing') {
                    setTimeout(checkStatus, 2000);
                } else {
                    setTimeout(checkStatus, 2000);
                }
            })
            .catch(() => {
                setTimeout(checkStatus, 3000);
            });
        };

        setTimeout(checkStatus, 1000);
    }

    function updateAnalysisStatusBar(data) {
        const step = data.step || 'starting';
        const progress = data.progress || 0;
        const message = data.message || 'Analyzing...';

        analysisProgressBar.style.width = progress + '%';
        analysisPercent.textContent = progress + '%';
        analysisStatusText.textContent = message;

        const steps = ['script', 'description', 'affiliate', 'conversion', 'script_score'];
        const stepMap = {
            'starting': -1, 'fetching': -1,
            'script': 0, 'description': 1, 'affiliate': 2, 'conversion': 3, 'script_score': 4,
            'saving': 5, 'completed': 6
        };

        const currentIdx = stepMap[step] !== undefined ? stepMap[step] : -1;
        steps.forEach((s, idx) => {
            const stepEl = document.getElementById('analysisStep-' + s);
            if (stepEl) {
                const icon = stepEl.querySelector('i');
                if (idx < currentIdx) {
                    icon.className = 'fas fa-check-circle text-white';
                } else if (idx === currentIdx) {
                    icon.className = 'fas fa-spinner fa-spin text-white';
                } else {
                    icon.className = 'fas fa-circle text-white-50';
                }
            }
        });
    }

    function showAnalysisCompletion(message) {
        analysisSpinner.style.display = 'none';
        analysisCheck.style.display = 'inline-block';
        analysisErrorIcon.style.display = 'none';
        analysisStatusText.textContent = message || 'Complete!';
        analysisProgressBar.style.width = '100%';
        analysisPercent.textContent = '100%';
        analysisProgressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
        showNavBadgeComplete();
    }

    function showAnalysisError(message) {
        analysisSpinner.style.display = 'none';
        analysisCheck.style.display = 'none';
        analysisErrorIcon.style.display = 'inline-block';
        analysisStatusText.textContent = message || 'Error occurred';
        reanalyzeBtn.disabled = false;
        showNavBadgeError();
    }

    // Reset modal on close
    document.getElementById('transcribeModal').addEventListener('hidden.bs.modal', function() {
        configSection.style.display = 'block';
        progressSection.style.display = 'none';
        completionSection.style.display = 'none';
        errorSection.style.display = 'none';
        modalFooter.style.display = 'block';
        modalCloseBtn.style.display = 'block';
        startBtn.style.display = 'inline-block';
        cancelBtn.textContent = 'Cancel';
    });

    // ==================== ON PAGE LOAD: RESUME IN-PROGRESS OPERATIONS ====================
    // Check if operations are in progress (for persistence across refresh/navigation)
    const isTranscribingOnLoad = {{ 'true' if is_transcribing else 'false' }};
    const isAnalyzingOnLoad = {{ 'true' if is_analyzing else 'false' }};

    if (isTranscribingOnLoad) {
        // Resume transcription status bar
        statusBar.style.display = 'block';
        statusSpinner.style.display = 'inline-block';
        statusCheck.style.display = 'none';
        statusErrorIcon.style.display = 'none';
        // statusCloseBtn always visible
        statusText.textContent = 'Transcription in progress...';
        // Show all possible steps (we don't know which were selected)
        document.getElementById('statusStep-download').style.display = 'inline';
        document.getElementById('statusStep-transcribe').style.display = 'inline';
        document.getElementById('statusStep-save').style.display = 'inline';
        // Disable the transcribe button
        document.querySelector('[data-bs-target="#transcribeModal"]').disabled = true;
        // Start polling
        pollStatusBar(true, false, false, false);
    }

    if (isAnalyzingOnLoad) {
        // Resume analysis status bar
        analysisStatusBar.style.display = 'block';
        analysisSpinner.style.display = 'inline-block';
        analysisCheck.style.display = 'none';
        analysisErrorIcon.style.display = 'none';
        // analysisCloseBtn always visible
        analysisStatusText.textContent = 'Analysis in progress...';
        // Disable the re-analyze button
        reanalyzeBtn.disabled = true;
        // Start polling
        pollAnalysisStatus();
    }

    // Update positions and badge if both are visible on load
    if (isTranscribingOnLoad || isAnalyzingOnLoad) {
        updateStatusBarPositions();
        updateNavBadge();
    }

});
</script>

{% if is_transcribing %}
<script>
    // Auto-refresh page every 10 seconds when transcription is in progress
    setTimeout(function() {
        location.reload();
    }, 10000);
</script>
{% endif %}
{% endblock %}
